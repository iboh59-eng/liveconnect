<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BrownTV">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="BrownTV - Random Video Chat weltweit">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <title>BrownTV</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        :root {
            --primary: #e94560;
            --primary-dark: #c73e54;
            --primary-light: #ff6b81;
            --secondary: #0f3460;
            --accent: #16c79a;
            --gold: #ffd700;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-elevated: #1f2b4d;
            --text: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #6a6a7a;
            --border: rgba(255,255,255,0.1);
            --success: #16c79a;
            --danger: #e94560;
            --warning: #f5a623;
            --shadow: 0 10px 40px rgba(0,0,0,0.3);
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
        }
        
        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            position: fixed;
            width: 100%;
            touch-action: pan-y;
        }
        
        /* ==================== APP CONTAINER ==================== */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }
        
        /* ==================== HEADER ==================== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(180deg, var(--bg-dark), transparent);
            position: absolute;
            top: var(--safe-top);
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 900;
            color: white;
            box-shadow: 0 4px 15px rgba(233,69,96,0.4);
        }
        
        .logo-text {
            font-size: 22px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .coins-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(255,215,0,0.15);
            border: 1px solid rgba(255,215,0,0.3);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gold);
        }
        
        .header-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 12px;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-btn:active {
            transform: scale(0.9);
            background: rgba(255,255,255,0.2);
        }
        
        /* ==================== STATS BAR ==================== */
        .stats-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            position: absolute;
            top: calc(var(--safe-top) + 64px);
            left: 16px;
            right: 16px;
            border-radius: 12px;
            z-index: 90;
            font-size: 12px;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
        }
        
        .stat-dot {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.5; }
        }
        
        .stat-item strong {
            color: var(--text);
            font-weight: 600;
        }
        
        /* ==================== VIDEO AREA ==================== */
        .video-area {
            flex: 1;
            position: relative;
            background: #000;
            overflow: hidden;
        }
        
        .remote-video-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remote-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ==================== VIDEO PLACEHOLDER ==================== */
        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-card));
            z-index: 5;
        }
        
        .placeholder-icon {
            width: 100px;
            height: 100px;
            background: var(--bg-elevated);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            border: 3px solid var(--border);
            animation: breathe 3s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .placeholder-text {
            font-size: 18px;
            color: var(--text-secondary);
            text-align: center;
        }
        
        .placeholder-subtext {
            font-size: 14px;
            color: var(--text-muted);
        }
        
        /* ==================== LOCAL VIDEO PIP ==================== */
        .local-pip {
            position: absolute;
            top: 130px;
            right: 16px;
            width: 100px;
            height: 140px;
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            border: 3px solid var(--border);
            z-index: 60;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .local-pip.connected {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(22,199,154,0.3);
        }
        
        .local-pip.large {
            width: 140px;
            height: 200px;
        }
        
        .local-pip video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .local-pip-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            font-size: 32px;
        }
        
        .pip-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 4px;
            padding: 6px;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
        }
        
        .pip-btn {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }
        
        .pip-btn:active {
            transform: scale(0.9);
        }
        
        .pip-btn.active {
            background: var(--primary);
        }
        
        /* ==================== PARTNER INFO ==================== */
        .partner-info {
            position: absolute;
            bottom: 220px;
            left: 16px;
            display: none;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            z-index: 50;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
        }
        
        .partner-info.active {
            display: flex;
        }
        
        .partner-avatar {
            width: 48px;
            height: 48px;
            background: var(--bg-elevated);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .partner-details h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .partner-details p {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .partner-likes {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
            padding: 4px 10px;
            background: rgba(233,69,96,0.2);
            border-radius: 12px;
            font-size: 12px;
            color: var(--primary-light);
        }
        
        /* ==================== SEARCHING OVERLAY ==================== */
        .searching-overlay {
            position: absolute;
            inset: 0;
            background: rgba(26,26,46,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            z-index: 70;
        }
        
        .searching-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
        }
        
        .search-animation {
            position: relative;
            width: 120px;
            height: 120px;
        }
        
        .search-ring {
            position: absolute;
            inset: 0;
            border: 4px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .search-ring:nth-child(2) {
            inset: 15px;
            border-top-color: var(--accent);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }
        
        .search-ring:nth-child(3) {
            inset: 30px;
            border-top-color: var(--primary-light);
            animation-duration: 2s;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .search-icon {
            position: absolute;
            inset: 40px;
            background: var(--bg-elevated);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        
        .searching-text {
            font-size: 20px;
            font-weight: 600;
        }
        
        .searching-subtext {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .cancel-search-btn {
            padding: 14px 36px;
            background: transparent;
            border: 2px solid var(--border);
            border-radius: 30px;
            color: var(--text);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cancel-search-btn:active {
            background: rgba(255,255,255,0.1);
            transform: scale(0.95);
        }
        
        /* ==================== MATCH ANIMATION ==================== */
        .match-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }
        
        .match-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .match-content {
            text-align: center;
            animation: matchPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes matchPop {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .match-emoji {
            font-size: 80px;
            margin-bottom: 16px;
            animation: matchBounce 0.6s ease-in-out infinite;
        }
        
        @keyframes matchBounce {
            0%, 100% { transform: scale(1) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }
        
        .match-text {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent), #00d9ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .match-name {
            font-size: 18px;
            color: var(--text-secondary);
        }
        
        /* ==================== CHAT OVERLAY ==================== */
        .chat-overlay {
            position: absolute;
            bottom: 200px;
            left: 0;
            right: 0;
            max-height: 200px;
            padding: 0 16px;
            pointer-events: none;
            z-index: 40;
            overflow: hidden;
        }
        
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            mask-image: linear-gradient(transparent 0%, black 30%);
            -webkit-mask-image: linear-gradient(transparent 0%, black 30%);
        }
        
        .chat-msg {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            pointer-events: auto;
            animation: msgPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            word-wrap: break-word;
        }
        
        @keyframes msgPop {
            0% { opacity: 0; transform: translateY(20px) scale(0.8); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .chat-msg.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-bottom-right-radius: 4px;
        }
        
        .chat-msg.received {
            align-self: flex-start;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-bottom-left-radius: 4px;
        }
        
        .chat-msg.system {
            align-self: center;
            background: rgba(0,0,0,0.5);
            font-size: 12px;
            color: var(--text-secondary);
            padding: 8px 16px;
        }
        
        /* ==================== ACTION ROW ==================== */
        .action-row {
            position: absolute;
            bottom: 150px;
            left: 0;
            right: 0;
            display: none;
            justify-content: center;
            gap: 10px;
            padding: 0 16px;
            z-index: 45;
        }
        
        .action-row.active {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 24px;
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-btn.liked {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .action-btn .emoji {
            font-size: 16px;
        }
        
        /* ==================== GIFT PANEL ==================== */
        .gift-panel {
            position: absolute;
            bottom: 200px;
            left: 16px;
            right: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 16px;
            z-index: 80;
            display: none;
            animation: slideUp 0.3s ease-out;
        }
        
        .gift-panel.active {
            display: block;
        }
        
        .gift-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .gift-panel-header h3 {
            font-size: 16px;
            font-weight: 600;
        }
        
        .gift-panel-close {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
        }
        
        .gift-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        
        .gift-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--bg-elevated);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .gift-item:active {
            transform: scale(0.95);
        }
        
        .gift-item.selected {
            border-color: var(--primary);
            background: rgba(233,69,96,0.1);
        }
        
        .gift-item .emoji {
            font-size: 28px;
        }
        
        .gift-item .coins {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 11px;
            color: var(--gold);
        }
        
        .send-gift-btn {
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .send-gift-btn:disabled {
            opacity: 0.5;
        }
        
        /* ==================== BOTTOM CONTROLS ==================== */
        .bottom-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            background: linear-gradient(transparent, rgba(0,0,0,0.9) 30%);
            z-index: 50;
        }
        
        .chat-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .chat-input-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 4px 4px 16px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 28px;
        }
        
        .chat-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            padding: 8px 0;
        }
        
        .chat-input::placeholder {
            color: var(--text-muted);
        }
        
        .chat-send-btn {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chat-send-btn:active {
            transform: scale(0.9);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.4;
        }
        
        .control-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .ctrl-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ctrl-btn:active {
            transform: scale(0.9);
        }
        
        .ctrl-btn:disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .ctrl-btn.muted {
            background: rgba(233,69,96,0.3);
        }
        
        .ctrl-btn.main {
            width: 68px;
            height: 68px;
            font-size: 28px;
        }
        
        .ctrl-btn.start {
            background: linear-gradient(135deg, var(--accent), #00d9a0);
            box-shadow: 0 4px 20px rgba(22,199,154,0.4);
        }
        
        .ctrl-btn.next {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: 0 4px 20px rgba(233,69,96,0.4);
        }
        
        .ctrl-btn.end {
            background: var(--danger);
            width: 52px;
            height: 52px;
            font-size: 20px;
        }
        
        /* ==================== START SCREEN ==================== */
        .start-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, var(--bg-dark), var(--secondary));
            display: flex;
            flex-direction: column;
            z-index: 1000;
            padding: 32px 24px;
            padding-top: calc(32px + var(--safe-top));
            padding-bottom: calc(32px + var(--safe-bottom));
            overflow-y: auto;
        }
        
        .start-screen.hidden {
            display: none;
        }
        
        .start-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .start-logo-big {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 900;
            color: white;
            margin-bottom: 24px;
            box-shadow: 0 20px 60px rgba(233,69,96,0.4);
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        .start-title {
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
            letter-spacing: -1px;
        }
        
        .start-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 32px;
            line-height: 1.5;
            max-width: 300px;
        }
        
        /* Gender Selection */
        .gender-selection {
            width: 100%;
            max-width: 320px;
            margin-bottom: 24px;
        }
        
        .gender-label {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            text-align: center;
        }
        
        .gender-buttons {
            display: flex;
            gap: 10px;
        }
        
        .gender-btn {
            flex: 1;
            padding: 14px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 14px;
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .gender-btn .emoji {
            font-size: 24px;
        }
        
        .gender-btn.selected {
            background: rgba(233,69,96,0.2);
            border-color: var(--primary);
        }
        
        /* Looking For */
        .looking-for {
            width: 100%;
            max-width: 320px;
            margin-bottom: 32px;
        }
        
        .looking-buttons {
            display: flex;
            gap: 8px;
        }
        
        .looking-btn {
            flex: 1;
            padding: 12px 8px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .looking-btn.selected {
            background: rgba(22,199,154,0.2);
            border-color: var(--accent);
        }
        
        .start-btn {
            width: 100%;
            max-width: 320px;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(233,69,96,0.4);
            transition: all 0.2s;
        }
        
        .start-btn:active {
            transform: scale(0.98);
        }
        
        .start-features {
            display: flex;
            gap: 24px;
            margin-top: 40px;
        }
        
        .feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .feature-icon {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.1);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }
        
        .feature span {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ==================== SETTINGS MODAL ==================== */
        .settings-modal {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 300;
            display: none;
            flex-direction: column;
            padding-top: var(--safe-top);
        }
        
        .settings-modal.active {
            display: flex;
            animation: slideIn 0.3s ease-out;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            font-size: 20px;
            font-weight: 700;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            background: var(--bg-elevated);
            border: none;
            border-radius: 12px;
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .setting-group {
            margin-bottom: 28px;
        }
        
        .setting-group-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }
        
        .setting-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .setting-opt {
            padding: 12px 18px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .setting-opt:active {
            transform: scale(0.95);
        }
        
        .setting-opt.selected {
            background: rgba(233,69,96,0.2);
            border-color: var(--primary);
        }
        
        .modal-footer {
            padding: 16px 20px;
            padding-bottom: calc(16px + var(--safe-bottom));
        }
        
        .save-settings-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* ==================== REPORT MODAL ==================== */
        .report-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 250;
        }
        
        .report-modal.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .report-content {
            width: 100%;
            max-width: 360px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            animation: matchPop 0.3s ease-out;
        }
        
        .report-content h3 {
            font-size: 18px;
            margin-bottom: 16px;
            text-align: center;
        }
        
        .report-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .report-opt {
            padding: 14px;
            background: var(--bg-elevated);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            text-align: left;
            cursor: pointer;
        }
        
        .report-opt.selected {
            border-color: var(--danger);
            background: rgba(233,69,96,0.1);
        }
        
        .report-buttons {
            display: flex;
            gap: 12px;
        }
        
        .report-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .report-btn.cancel {
            background: var(--bg-elevated);
            color: var(--text);
        }
        
        .report-btn.submit {
            background: var(--danger);
            color: white;
        }
        
        /* ==================== FRIEND REQUEST ==================== */
        .friend-request-popup {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px 20px;
            z-index: 180;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }
        
        .friend-request-popup.active {
            display: flex;
        }
        
        .friend-request-popup p {
            font-size: 14px;
        }
        
        .friend-request-popup strong {
            color: var(--primary-light);
        }
        
        .friend-request-buttons {
            display: flex;
            gap: 8px;
        }
        
        .friend-req-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .friend-req-btn.accept {
            background: var(--accent);
            color: white;
        }
        
        .friend-req-btn.decline {
            background: var(--bg-elevated);
            color: var(--text);
        }
        
        /* ==================== TOAST NOTIFICATIONS ==================== */
        .toast-container {
            position: fixed;
            top: calc(20px + var(--safe-top));
            left: 50%;
            transform: translateX(-50%);
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        
        .toast {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            animation: toastIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: scale(0.8) translateY(-20px); }
        }
        
        .toast.success { border-color: var(--accent); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        
        /* ==================== GIFT ANIMATION ==================== */
        .gift-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            z-index: 400;
            pointer-events: none;
            animation: giftBurst 1.5s ease-out forwards;
        }
        
        @keyframes giftBurst {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-30deg); opacity: 1; }
            30% { transform: translate(-50%, -50%) scale(1.5) rotate(15deg); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(0.3) rotate(-15deg); opacity: 0; }
        }
        
        /* ==================== LIKE ANIMATION ==================== */
        .like-animation {
            position: fixed;
            font-size: 80px;
            pointer-events: none;
            z-index: 400;
            animation: likeFly 1s ease-out forwards;
        }
        
        @keyframes likeFly {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
        }
        
        /* ==================== RESPONSIVE ==================== */
        @media (max-height: 600px) {
            .start-logo-big { width: 80px; height: 80px; font-size: 32px; margin-bottom: 16px; }
            .start-title { font-size: 32px; }
            .start-subtitle { font-size: 14px; margin-bottom: 20px; }
            .gender-selection, .looking-for { margin-bottom: 16px; }
            .start-features { margin-top: 24px; }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 8px 16px; }
            .stats-bar { top: calc(var(--safe-top) + 50px); }
            .local-pip { top: 100px; width: 80px; height: 100px; }
            .bottom-controls { padding: 8px 16px; }
            .ctrl-btn { width: 44px; height: 44px; font-size: 18px; }
            .ctrl-btn.main { width: 56px; height: 56px; }
        }
        
        @media (min-width: 768px) {
            .local-pip { width: 160px; height: 220px; }
            .local-pip.large { width: 200px; height: 280px; }
            .gift-grid { grid-template-columns: repeat(6, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toasts"></div>
    
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-content">
            <div class="start-logo-big">üì∫</div>
            <h1 class="start-title">BrownTV</h1>
            <p class="start-subtitle">Video-Chat mit echten Menschen aus aller Welt. Kostenlos & sicher.</p>
            
            <div class="gender-selection">
                <div class="gender-label">Ich bin</div>
                <div class="gender-buttons" id="genderButtons">
                    <button class="gender-btn" data-gender="male">
                        <span class="emoji">üë®</span>
                        <span>Mann</span>
                    </button>
                    <button class="gender-btn" data-gender="female">
                        <span class="emoji">üë©</span>
                        <span>Frau</span>
                    </button>
                </div>
            </div>
            
            <div class="looking-for">
                <div class="gender-label">Ich suche</div>
                <div class="looking-buttons" id="lookingButtons">
                    <button class="looking-btn selected" data-looking="all">üåç Alle</button>
                    <button class="looking-btn" data-looking="male">üë® M√§nner</button>
                    <button class="looking-btn" data-looking="female">üë© Frauen</button>
                </div>
            </div>
            
            <button class="start-btn" id="startBtn">Los geht's üöÄ</button>
            
            <div class="start-features">
                <div class="feature">
                    <div class="feature-icon">üîí</div>
                    <span>Sicher</span>
                </div>
                <div class="feature">
                    <div class="feature-icon">üåç</div>
                    <span>Weltweit</span>
                </div>
                <div class="feature">
                    <div class="feature-icon">üí¨</div>
                    <span>Live Chat</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="modal-header">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <button class="modal-close" id="settingsClose">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="setting-group">
                <div class="setting-group-label">Mein Geschlecht</div>
                <div class="setting-options" id="settingsGender">
                    <button class="setting-opt" data-val="male">üë® Mann</button>
                    <button class="setting-opt" data-val="female">üë© Frau</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-label">Ich suche</div>
                <div class="setting-options" id="settingsLooking">
                    <button class="setting-opt selected" data-val="all">üåç Alle</button>
                    <button class="setting-opt" data-val="male">üë® M√§nner</button>
                    <button class="setting-opt" data-val="female">üë© Frauen</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-group-label">Region</div>
                <div class="setting-options" id="settingsRegion">
                    <button class="setting-opt selected" data-val="">üåç Weltweit</button>
                    <button class="setting-opt" data-val="europe">üá™üá∫ Europa</button>
                    <button class="setting-opt" data-val="americas">üåé Amerika</button>
                    <button class="setting-opt" data-val="asia">üåè Asien</button>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="save-settings-btn" id="saveSettings">Speichern</button>
        </div>
    </div>
    
    <!-- Report Modal -->
    <div class="report-modal" id="reportModal">
        <div class="report-content">
            <h3>üö© Benutzer melden</h3>
            <div class="report-options" id="reportOptions">
                <button class="report-opt" data-reason="inappropriate">Unangemessenes Verhalten</button>
                <button class="report-opt" data-reason="spam">Spam / Werbung</button>
                <button class="report-opt" data-reason="harassment">Bel√§stigung</button>
                <button class="report-opt" data-reason="underage">Minderj√§hrig</button>
                <button class="report-opt" data-reason="other">Sonstiges</button>
            </div>
            <div class="report-buttons">
                <button class="report-btn cancel" id="reportCancel">Abbrechen</button>
                <button class="report-btn submit" id="reportSubmit">Melden</button>
            </div>
        </div>
    </div>
    
    <!-- Friend Request Popup -->
    <div class="friend-request-popup" id="friendRequestPopup">
        <p><strong id="friendRequestName">User</strong> m√∂chte dein Freund sein!</p>
        <div class="friend-request-buttons">
            <button class="friend-req-btn accept" id="acceptFriend">‚úì</button>
            <button class="friend-req-btn decline" id="declineFriend">‚úï</button>
        </div>
    </div>
    
    <!-- Match Overlay -->
    <div class="match-overlay" id="matchOverlay">
        <div class="match-content">
            <div class="match-emoji">üéâ</div>
            <div class="match-text">Verbunden!</div>
            <div class="match-name" id="matchName"></div>
        </div>
    </div>
    
    <!-- Gift Panel -->
    <div class="gift-panel" id="giftPanel">
        <div class="gift-panel-header">
            <h3>üéÅ Geschenk senden</h3>
            <button class="gift-panel-close" id="giftPanelClose">‚úï</button>
        </div>
        <div class="gift-grid" id="giftGrid"></div>
        <button class="send-gift-btn" id="sendGiftBtn" disabled>Senden</button>
    </div>
    
    <!-- Main App -->
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üì∫</div>
                <span class="logo-text">BrownTV</span>
            </div>
            <div class="header-right">
                <div class="coins-display">
                    <span>üí∞</span>
                    <span id="coinsAmount">100</span>
                </div>
                <button class="header-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </header>
        
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-dot"></div>
                <span><strong id="onlineCount">0</strong> online</span>
            </div>
            <div class="stat-item">
                <span>üîç <strong id="searchingCount">0</strong></span>
            </div>
        </div>
        
        <div class="video-area">
            <!-- Remote Video -->
            <div class="remote-video-container">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-placeholder" id="remotePlaceholder">
                    <div class="placeholder-icon">üîç</div>
                    <div class="placeholder-text">Bereit f√ºr Video-Chat</div>
                    <div class="placeholder-subtext">Tippe Start um jemanden zu finden</div>
                </div>
            </div>
            
            <!-- Local Video PIP -->
            <div class="local-pip" id="localPip">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="local-pip-placeholder" id="localPlaceholder">üë§</div>
                <div class="pip-controls">
                    <button class="pip-btn" id="flipCamBtn">üîÑ</button>
                    <button class="pip-btn" id="togglePipSize">‚ÜîÔ∏è</button>
                </div>
            </div>
            
            <!-- Partner Info -->
            <div class="partner-info" id="partnerInfo">
                <div class="partner-avatar" id="partnerAvatar">üåç</div>
                <div class="partner-details">
                    <h3 id="partnerName">Partner</h3>
                    <p id="partnerCountry">Verbindet...</p>
                </div>
            </div>
            
            <!-- Searching Overlay -->
            <div class="searching-overlay" id="searchingOverlay">
                <div class="search-animation">
                    <div class="search-ring"></div>
                    <div class="search-ring"></div>
                    <div class="search-ring"></div>
                    <div class="search-icon">üîç</div>
                </div>
                <div class="searching-text">Suche Partner...</div>
                <div class="searching-subtext" id="searchingPosition"></div>
                <button class="cancel-search-btn" id="cancelSearchBtn">Abbrechen</button>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-overlay">
                <div class="chat-messages" id="chatMessages"></div>
            </div>
            
            <!-- Action Row -->
            <div class="action-row" id="actionRow">
                <button class="action-btn" id="likeBtn">
                    <span class="emoji">‚ù§Ô∏è</span> Like
                </button>
                <button class="action-btn" id="giftBtn">
                    <span class="emoji">üéÅ</span> Gift
                </button>
                <button class="action-btn" id="friendBtn">
                    <span class="emoji">üë•</span> Freund
                </button>
            </div>
            
            <!-- Bottom Controls -->
            <div class="bottom-controls">
                <div class="chat-input-row">
                    <div class="chat-input-wrap">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht schreiben..." maxlength="500" autocomplete="off">
                        <button class="chat-send-btn" id="chatSendBtn" disabled>‚û§</button>
                    </div>
                </div>
                <div class="control-row">
                    <button class="ctrl-btn" id="micBtn" disabled>üé§</button>
                    <button class="ctrl-btn" id="camBtn" disabled>üìπ</button>
                    <button class="ctrl-btn main start" id="startCallBtn">‚ñ∂Ô∏è</button>
                    <button class="ctrl-btn main next" id="nextBtn" style="display:none">‚è≠Ô∏è</button>
                    <button class="ctrl-btn end" id="endBtn" style="display:none">‚úï</button>
                    <button class="ctrl-btn" id="reportBtn" disabled>üö©</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    // ============================================
    // CAMERA FIX - IMPROVED DEVICE HANDLING
    // ============================================
    
    class CameraManager {
        constructor() {
            this.devices = [];
            this.currentDeviceIndex = 0;
            this.stream = null;
            this.facingMode = 'user';
        }
        
        async init() {
            try {
                // First get permission with any camera
                const tempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                tempStream.getTracks().forEach(t => t.stop());
                
                // Now enumerate devices
                await this.refreshDevices();
                return true;
            } catch (e) {
                console.error('Camera init error:', e);
                return false;
            }
        }
        
        async refreshDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                this.devices = devices.filter(d => d.kind === 'videoinput');
                console.log('Available cameras:', this.devices.length);
                return this.devices;
            } catch (e) {
                console.error('Enumerate devices error:', e);
                return [];
            }
        }
        
        async getStream(preferFront = true) {
            // Stop existing stream first
            this.stopStream();
            
            const constraints = {
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                },
                video: true
            };
            
            // Try with facingMode first (works best on mobile)
            if (this.devices.length <= 2) {
                this.facingMode = preferFront ? 'user' : 'environment';
                constraints.video = {
                    facingMode: { ideal: this.facingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                };
            } else {
                // Multiple cameras - use deviceId
                const device = this.devices[this.currentDeviceIndex];
                if (device) {
                    constraints.video = {
                        deviceId: { exact: device.deviceId },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    };
                }
            }
            
            try {
                this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                return this.stream;
            } catch (e) {
                console.error('GetUserMedia error:', e);
                
                // Fallback: try without constraints
                try {
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    return this.stream;
                } catch (e2) {
                    console.error('Fallback camera error:', e2);
                    return null;
                }
            }
        }
        
        async switchCamera() {
            if (this.devices.length < 2) {
                console.log('Only one camera available');
                return this.stream;
            }
            
            // Method 1: Toggle facingMode (best for mobile)
            if (this.devices.length === 2) {
                const wasFront = this.facingMode === 'user';
                return await this.getStream(!wasFront);
            }
            
            // Method 2: Cycle through devices
            this.currentDeviceIndex = (this.currentDeviceIndex + 1) % this.devices.length;
            return await this.getStream(this.currentDeviceIndex === 0);
        }
        
        stopStream() {
            if (this.stream) {
                this.stream.getTracks().forEach(track => {
                    track.stop();
                });
                this.stream = null;
            }
        }
        
        toggleAudio(enabled) {
            if (this.stream) {
                this.stream.getAudioTracks().forEach(track => {
                    track.enabled = enabled;
                });
            }
        }
        
        toggleVideo(enabled) {
            if (this.stream) {
                this.stream.getVideoTracks().forEach(track => {
                    track.enabled = enabled;
                });
            }
        }
        
        getVideoTrack() {
            return this.stream?.getVideoTracks()[0] || null;
        }
        
        getAudioTrack() {
            return this.stream?.getAudioTracks()[0] || null;
        }
    }
    
    // ============================================
    // ICE SERVERS CONFIG
    // ============================================
    
    const ICE_SERVERS = [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' },
        { 
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        { 
            urls: 'turn:openrelay.metered.ca:443',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        },
        { 
            urls: 'turn:openrelay.metered.ca:443?transport=tcp',
            username: 'openrelayproject',
            credential: 'openrelayproject'
        }
    ];
    
    // ============================================
    // STATE
    // ============================================
    
    const camera = new CameraManager();
    
    const state = {
        socket: null,
        pc: null,
        user: null,
        partner: null,
        gifts: [],
        selectedGift: null,
        inCall: false,
        searching: false,
        micOn: true,
        camOn: true,
        liked: false,
        pendingFriendRequest: null,
        reportReason: null,
        settings: {
            gender: null,
            lookingFor: 'all',
            region: null
        }
    };
    
    // ============================================
    // DOM ELEMENTS
    // ============================================
    
    const $ = id => document.getElementById(id);
    const el = {
        startScreen: $('startScreen'),
        startBtn: $('startBtn'),
        genderButtons: $('genderButtons'),
        lookingButtons: $('lookingButtons'),
        settingsModal: $('settingsModal'),
        settingsBtn: $('settingsBtn'),
        settingsClose: $('settingsClose'),
        saveSettings: $('saveSettings'),
        reportModal: $('reportModal'),
        reportOptions: $('reportOptions'),
        reportCancel: $('reportCancel'),
        reportSubmit: $('reportSubmit'),
        friendRequestPopup: $('friendRequestPopup'),
        friendRequestName: $('friendRequestName'),
        acceptFriend: $('acceptFriend'),
        declineFriend: $('declineFriend'),
        matchOverlay: $('matchOverlay'),
        matchName: $('matchName'),
        giftPanel: $('giftPanel'),
        giftGrid: $('giftGrid'),
        giftPanelClose: $('giftPanelClose'),
        sendGiftBtn: $('sendGiftBtn'),
        localVideo: $('localVideo'),
        remoteVideo: $('remoteVideo'),
        localPip: $('localPip'),
        localPlaceholder: $('localPlaceholder'),
        remotePlaceholder: $('remotePlaceholder'),
        flipCamBtn: $('flipCamBtn'),
        togglePipSize: $('togglePipSize'),
        partnerInfo: $('partnerInfo'),
        partnerAvatar: $('partnerAvatar'),
        partnerName: $('partnerName'),
        partnerCountry: $('partnerCountry'),
        searchingOverlay: $('searchingOverlay'),
        searchingPosition: $('searchingPosition'),
        cancelSearchBtn: $('cancelSearchBtn'),
        chatMessages: $('chatMessages'),
        chatInput: $('chatInput'),
        chatSendBtn: $('chatSendBtn'),
        actionRow: $('actionRow'),
        likeBtn: $('likeBtn'),
        giftBtn: $('giftBtn'),
        friendBtn: $('friendBtn'),
        micBtn: $('micBtn'),
        camBtn: $('camBtn'),
        startCallBtn: $('startCallBtn'),
        nextBtn: $('nextBtn'),
        endBtn: $('endBtn'),
        reportBtn: $('reportBtn'),
        coinsAmount: $('coinsAmount'),
        onlineCount: $('onlineCount'),
        searchingCount: $('searchingCount'),
        toasts: $('toasts')
    };
    
    // ============================================
    // UTILITIES
    // ============================================
    
    function toast(msg, type = '') {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        el.toasts.appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
    
    function vibrate(pattern = 50) {
        if (navigator.vibrate) {
            navigator.vibrate(pattern);
        }
    }
    
    function showGiftAnimation(emoji) {
        const g = document.createElement('div');
        g.className = 'gift-animation';
        g.textContent = emoji;
        document.body.appendChild(g);
        vibrate([100, 50, 100]);
        setTimeout(() => g.remove(), 1500);
    }
    
    function showLikeAnimation(x, y) {
        const heart = document.createElement('div');
        heart.className = 'like-animation';
        heart.textContent = '‚ù§Ô∏è';
        heart.style.left = x + 'px';
        heart.style.top = y + 'px';
        document.body.appendChild(heart);
        vibrate(100);
        setTimeout(() => heart.remove(), 1000);
    }
    
    function addChatMsg(text, type) {
        const msg = document.createElement('div');
        msg.className = `chat-msg ${type}`;
        msg.textContent = text;
        el.chatMessages.appendChild(msg);
        el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
        
        // Keep only last 30 messages
        while (el.chatMessages.children.length > 30) {
            el.chatMessages.removeChild(el.chatMessages.firstChild);
        }
    }
    
    function clearChat() {
        el.chatMessages.innerHTML = '';
    }
    
    function updateUI() {
        const inCall = state.inCall;
        
        el.startCallBtn.style.display = inCall ? 'none' : 'flex';
        el.nextBtn.style.display = inCall ? 'flex' : 'none';
        el.endBtn.style.display = inCall ? 'flex' : 'none';
        el.actionRow.classList.toggle('active', inCall);
        el.localPip.classList.toggle('connected', inCall);
        el.chatInput.disabled = !inCall;
        el.chatSendBtn.disabled = !inCall;
        el.reportBtn.disabled = !inCall;
        
        // Update like button
        el.likeBtn.classList.toggle('liked', state.liked);
        el.likeBtn.innerHTML = state.liked ? '<span class="emoji">‚ù§Ô∏è</span> Liked!' : '<span class="emoji">‚ù§Ô∏è</span> Like';
    }
    
    function renderGiftGrid() {
        el.giftGrid.innerHTML = '';
        state.gifts.forEach(gift => {
            const item = document.createElement('div');
            item.className = 'gift-item';
            item.dataset.id = gift.id;
            item.innerHTML = `
                <span class="emoji">${gift.emoji}</span>
                <span class="coins">üí∞ ${gift.coins}</span>
            `;
            item.onclick = () => selectGift(gift);
            el.giftGrid.appendChild(item);
        });
    }
    
    function selectGift(gift) {
        state.selectedGift = gift;
        el.giftGrid.querySelectorAll('.gift-item').forEach(item => {
            item.classList.toggle('selected', item.dataset.id === gift.id);
        });
        el.sendGiftBtn.disabled = false;
        el.sendGiftBtn.textContent = `${gift.emoji} Senden (${gift.coins} üí∞)`;
    }
    
    // ============================================
    // WEBRTC
    // ============================================
    
    function createPeerConnection() {
        const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
        
        // Add local tracks
        if (camera.stream) {
            camera.stream.getTracks().forEach(track => {
                pc.addTrack(track, camera.stream);
            });
        }
        
        // Handle remote stream
        pc.ontrack = (event) => {
            console.log('Remote track received');
            el.remoteVideo.srcObject = event.streams[0];
            el.remotePlaceholder.style.display = 'none';
        };
        
        // Handle ICE candidates
        pc.onicecandidate = (event) => {
            if (event.candidate) {
                state.socket.emit('ice-candidate', { candidate: event.candidate });
            }
        };
        
        // Connection state
        pc.onconnectionstatechange = () => {
            console.log('Connection state:', pc.connectionState);
            if (pc.connectionState === 'connected') {
                toast('Verbunden!', 'success');
                vibrate(100);
            } else if (['disconnected', 'failed', 'closed'].includes(pc.connectionState)) {
                if (state.inCall) {
                    handlePartnerLeft('connection');
                }
            }
        };
        
        state.pc = pc;
        return pc;
    }
    
    async function createOffer() {
        if (!state.pc) createPeerConnection();
        
        try {
            const offer = await state.pc.createOffer();
            await state.pc.setLocalDescription(offer);
            state.socket.emit('webrtc-offer', { offer });
        } catch (e) {
            console.error('Create offer error:', e);
        }
    }
    
    async function handleOffer(offer) {
        if (!state.pc) createPeerConnection();
        
        try {
            await state.pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await state.pc.createAnswer();
            await state.pc.setLocalDescription(answer);
            state.socket.emit('webrtc-answer', { answer });
        } catch (e) {
            console.error('Handle offer error:', e);
        }
    }
    
    async function handleAnswer(answer) {
        try {
            await state.pc?.setRemoteDescription(new RTCSessionDescription(answer));
        } catch (e) {
            console.error('Handle answer error:', e);
        }
    }
    
    async function handleIceCandidate(candidate) {
        try {
            await state.pc?.addIceCandidate(new RTCIceCandidate(candidate));
        } catch (e) {
            console.error('Add ICE candidate error:', e);
        }
    }
    
    function closePeerConnection() {
        if (state.pc) {
            state.pc.close();
            state.pc = null;
        }
        el.remoteVideo.srcObject = null;
        el.remotePlaceholder.style.display = 'flex';
    }
    
    // Replace track in peer connection
    async function replaceVideoTrack(newTrack) {
        if (!state.pc || !newTrack) return;
        
        const senders = state.pc.getSenders();
        const videoSender = senders.find(s => s.track?.kind === 'video');
        
        if (videoSender) {
            await videoSender.replaceTrack(newTrack);
        }
    }
    
    // ============================================
    // SOCKET HANDLERS
    // ============================================
    
    function initSocket() {
        state.socket = io();
        
        state.socket.on('connect', () => {
            console.log('Connected to server');
            toast('Verbunden', 'success');
        });
        
        state.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            toast('Verbindung verloren', 'error');
        });
        
        state.socket.on('init', (data) => {
            state.user = data.user;
            state.gifts = data.gifts;
            el.coinsAmount.textContent = data.user.coins;
            renderGiftGrid();
        });
        
        state.socket.on('profile-updated', (data) => {
            state.user = data.user;
        });
        
        state.socket.on('stats', (data) => {
            el.onlineCount.textContent = data.online;
            el.searchingCount.textContent = data.searching;
        });
        
        state.socket.on('searching', (data) => {
            state.searching = true;
            el.searchingOverlay.classList.add('active');
            el.searchingPosition.textContent = `Position: ${data.position}`;
        });
        
        state.socket.on('search-cancelled', () => {
            state.searching = false;
            el.searchingOverlay.classList.remove('active');
        });
        
        state.socket.on('match-found', (data) => {
            console.log('Match found!', data);
            state.searching = false;
            state.inCall = true;
            state.partner = data.partner;
            state.liked = false;
            
            el.searchingOverlay.classList.remove('active');
            
            // Show match animation
            el.matchName.textContent = `${data.partner.country.code} ${data.partner.name}`;
            el.matchOverlay.classList.add('active');
            vibrate([100, 50, 100, 50, 100]);
            
            setTimeout(() => {
                el.matchOverlay.classList.remove('active');
                
                // Update partner info
                el.partnerAvatar.textContent = data.partner.country.code;
                el.partnerName.textContent = data.partner.name;
                el.partnerCountry.textContent = data.partner.country.name;
                el.partnerInfo.classList.add('active');
                
                // Setup WebRTC
                createPeerConnection();
                if (data.isInitiator) {
                    createOffer();
                }
                
                clearChat();
                addChatMsg(`Verbunden mit ${data.partner.name}`, 'system');
                updateUI();
            }, 1500);
        });
        
        state.socket.on('partner-left', (data) => {
            handlePartnerLeft(data.reason);
        });
        
        state.socket.on('ready-for-next', () => {
            // Auto-find next partner
            state.socket.emit('find-match');
        });
        
        state.socket.on('webrtc-offer', (data) => handleOffer(data.offer));
        state.socket.on('webrtc-answer', (data) => handleAnswer(data.answer));
        state.socket.on('ice-candidate', (data) => handleIceCandidate(data.candidate));
        
        state.socket.on('chat-message', (data) => {
            addChatMsg(data.message, 'received');
        });
        
        state.socket.on('received-like', (data) => {
            toast('‚ù§Ô∏è Du hast ein Like bekommen!', 'success');
            showLikeAnimation(window.innerWidth / 2, window.innerHeight / 2);
        });
        
        state.socket.on('like-sent', () => {
            state.liked = true;
            updateUI();
        });
        
        state.socket.on('received-gift', (data) => {
            showGiftAnimation(data.gift.emoji);
            toast(`${data.gift.emoji} ${data.gift.name} von ${data.from}!`, 'success');
            el.coinsAmount.textContent = data.newCoins;
        });
        
        state.socket.on('gift-sent', (data) => {
            el.coinsAmount.textContent = data.newCoins;
            el.giftPanel.classList.remove('active');
            toast(`${data.gift.emoji} Geschenk gesendet!`, 'success');
        });
        
        state.socket.on('insufficient-coins', (data) => {
            toast(`Nicht genug Coins! (${data.have}/${data.needed})`, 'error');
        });
        
        state.socket.on('friend-request', (data) => {
            state.pendingFriendRequest = data;
            el.friendRequestName.textContent = data.from;
            el.friendRequestPopup.classList.add('active');
        });
        
        state.socket.on('friend-request-sent', () => {
            toast('Freundschaftsanfrage gesendet', 'success');
        });
        
        state.socket.on('friend-request-accepted', (data) => {
            toast(`${data.by} hat deine Anfrage angenommen!`, 'success');
        });
        
        state.socket.on('friend-added', (data) => {
            toast(`${data.friend} ist jetzt dein Freund!`, 'success');
        });
        
        state.socket.on('user-blocked', () => {
            toast('Benutzer blockiert', 'warning');
        });
        
        state.socket.on('report-submitted', () => {
            toast('Meldung gesendet', 'warning');
            el.reportModal.classList.remove('active');
        });
    }
    
    function handlePartnerLeft(reason) {
        state.inCall = false;
        state.partner = null;
        state.liked = false;
        
        closePeerConnection();
        
        el.partnerInfo.classList.remove('active');
        el.giftPanel.classList.remove('active');
        updateUI();
        
        let msg = 'Partner hat den Chat verlassen';
        if (reason === 'skipped') msg = 'Partner hat weitergewechselt';
        else if (reason === 'blocked') msg = 'Du wurdest blockiert';
        
        addChatMsg(msg, 'system');
        toast(msg);
        vibrate(50);
    }
    
    // ============================================
    // EVENT HANDLERS
    // ============================================
    
    async function startApp() {
        el.startScreen.classList.add('hidden');
        
        // Get gender selection
        const selectedGender = el.genderButtons.querySelector('.selected');
        const selectedLooking = el.lookingButtons.querySelector('.selected');
        
        state.settings.gender = selectedGender?.dataset.gender || null;
        state.settings.lookingFor = selectedLooking?.dataset.looking || 'all';
        
        // Initialize camera
        const success = await camera.init();
        if (!success) {
            toast('Kamera konnte nicht gestartet werden', 'error');
            return;
        }
        
        const stream = await camera.getStream(true);
        if (stream) {
            el.localVideo.srcObject = stream;
            el.localPlaceholder.style.display = 'none';
            el.micBtn.disabled = false;
            el.camBtn.disabled = false;
        }
        
        // Initialize socket
        initSocket();
        
        // Send profile after connection
        setTimeout(() => {
            if (state.socket?.connected) {
                state.socket.emit('update-profile', {
                    gender: state.settings.gender,
                    lookingFor: state.settings.lookingFor
                });
            }
        }, 500);
    }
    
    async function flipCamera() {
        const newStream = await camera.switchCamera();
        if (newStream) {
            el.localVideo.srcObject = newStream;
            
            // Replace track in peer connection if in call
            if (state.inCall && state.pc) {
                const videoTrack = camera.getVideoTrack();
                await replaceVideoTrack(videoTrack);
            }
            
            vibrate(50);
        } else {
            toast('Kamerawechsel fehlgeschlagen', 'error');
        }
    }
    
    function toggleMic() {
        state.micOn = !state.micOn;
        camera.toggleAudio(state.micOn);
        el.micBtn.classList.toggle('muted', !state.micOn);
        el.micBtn.textContent = state.micOn ? 'üé§' : 'üîá';
        vibrate(30);
    }
    
    function toggleCam() {
        state.camOn = !state.camOn;
        camera.toggleVideo(state.camOn);
        el.camBtn.classList.toggle('muted', !state.camOn);
        el.camBtn.textContent = state.camOn ? 'üìπ' : 'üì∑';
        vibrate(30);
    }
    
    function startSearch() {
        if (!state.socket?.connected) {
            toast('Nicht verbunden', 'error');
            return;
        }
        
        state.socket.emit('find-match');
        vibrate(50);
    }
    
    function cancelSearch() {
        state.socket.emit('cancel-search');
        state.searching = false;
        el.searchingOverlay.classList.remove('active');
    }
    
    function nextPartner() {
        state.socket.emit('next-partner');
        closePeerConnection();
        el.partnerInfo.classList.remove('active');
        el.giftPanel.classList.remove('active');
        state.inCall = false;
        state.liked = false;
        updateUI();
        vibrate(50);
    }
    
    function endCall() {
        state.socket.emit('end-call');
        closePeerConnection();
        el.partnerInfo.classList.remove('active');
        el.giftPanel.classList.remove('active');
        state.inCall = false;
        state.partner = null;
        state.liked = false;
        updateUI();
        addChatMsg('Anruf beendet', 'system');
        vibrate(50);
    }
    
    function sendMessage() {
        const msg = el.chatInput.value.trim();
        if (msg && state.inCall) {
            addChatMsg(msg, 'sent');
            state.socket.emit('chat-message', { message: msg });
            el.chatInput.value = '';
        }
    }
    
    function sendLike(e) {
        if (!state.inCall || state.liked) return;
        state.socket.emit('like-partner');
        showLikeAnimation(e.clientX || window.innerWidth / 2, e.clientY || window.innerHeight / 2);
    }
    
    function openGiftPanel() {
        if (!state.inCall) return;
        state.selectedGift = null;
        el.giftGrid.querySelectorAll('.gift-item').forEach(i => i.classList.remove('selected'));
        el.sendGiftBtn.disabled = true;
        el.sendGiftBtn.textContent = 'Ausw√§hlen...';
        el.giftPanel.classList.add('active');
    }
    
    function sendGift() {
        if (!state.selectedGift || !state.inCall) return;
        state.socket.emit('send-gift', { giftId: state.selectedGift.id });
    }
    
    function sendFriendRequest() {
        if (!state.inCall) return;
        state.socket.emit('send-friend-request');
    }
    
    function acceptFriendRequest() {
        if (state.pendingFriendRequest) {
            state.socket.emit('accept-friend-request', { fromId: state.pendingFriendRequest.fromId });
            el.friendRequestPopup.classList.remove('active');
            state.pendingFriendRequest = null;
        }
    }
    
    function declineFriendRequest() {
        if (state.pendingFriendRequest) {
            state.socket.emit('decline-friend-request', { fromId: state.pendingFriendRequest.fromId });
            el.friendRequestPopup.classList.remove('active');
            state.pendingFriendRequest = null;
        }
    }
    
    function openReport() {
        if (!state.inCall) return;
        state.reportReason = null;
        el.reportOptions.querySelectorAll('.report-opt').forEach(o => o.classList.remove('selected'));
        el.reportModal.classList.add('active');
    }
    
    function submitReport() {
        if (!state.reportReason) {
            toast('Bitte w√§hle einen Grund', 'warning');
            return;
        }
        state.socket.emit('report-user', { reason: state.reportReason });
    }
    
    function saveSettings() {
        const gender = el.settingsModal.querySelector('#settingsGender .selected')?.dataset.val;
        const looking = el.settingsModal.querySelector('#settingsLooking .selected')?.dataset.val || 'all';
        const region = el.settingsModal.querySelector('#settingsRegion .selected')?.dataset.val || null;
        
        state.settings = { gender, lookingFor: looking, region };
        
        state.socket?.emit('update-profile', {
            gender,
            lookingFor: looking,
            regionFilter: region
        });
        
        el.settingsModal.classList.remove('active');
        toast('Einstellungen gespeichert', 'success');
        vibrate(50);
    }
    
    // ============================================
    // INIT
    // ============================================
    
    function init() {
        // Start screen
        el.startBtn.onclick = startApp;
        
        // Gender buttons on start screen
        el.genderButtons.querySelectorAll('.gender-btn').forEach(btn => {
            btn.onclick = () => {
                el.genderButtons.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            };
        });
        
        el.lookingButtons.querySelectorAll('.looking-btn').forEach(btn => {
            btn.onclick = () => {
                el.lookingButtons.querySelectorAll('.looking-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
            };
        });
        
        // Settings
        el.settingsBtn.onclick = () => el.settingsModal.classList.add('active');
        el.settingsClose.onclick = () => el.settingsModal.classList.remove('active');
        el.saveSettings.onclick = saveSettings;
        
        // Settings options
        ['settingsGender', 'settingsLooking', 'settingsRegion'].forEach(id => {
            $(id).querySelectorAll('.setting-opt').forEach(opt => {
                opt.onclick = () => {
                    $(id).querySelectorAll('.setting-opt').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                };
            });
        });
        
        // Camera controls
        el.flipCamBtn.onclick = flipCamera;
        el.togglePipSize.onclick = () => el.localPip.classList.toggle('large');
        el.micBtn.onclick = toggleMic;
        el.camBtn.onclick = toggleCam;
        
        // Call controls
        el.startCallBtn.onclick = startSearch;
        el.cancelSearchBtn.onclick = cancelSearch;
        el.nextBtn.onclick = nextPartner;
        el.endBtn.onclick = endCall;
        
        // Chat
        el.chatSendBtn.onclick = sendMessage;
        el.chatInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };
        
        // Actions
        el.likeBtn.onclick = sendLike;
        el.giftBtn.onclick = openGiftPanel;
        el.friendBtn.onclick = sendFriendRequest;
        el.giftPanelClose.onclick = () => el.giftPanel.classList.remove('active');
        el.sendGiftBtn.onclick = sendGift;
        
        // Friend request
        el.acceptFriend.onclick = acceptFriendRequest;
        el.declineFriend.onclick = declineFriendRequest;
        
        // Report
        el.reportBtn.onclick = openReport;
        el.reportCancel.onclick = () => el.reportModal.classList.remove('active');
        el.reportSubmit.onclick = submitReport;
        el.reportOptions.querySelectorAll('.report-opt').forEach(opt => {
            opt.onclick = () => {
                el.reportOptions.querySelectorAll('.report-opt').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                state.reportReason = opt.dataset.reason;
            };
        });
        
        // Swipe for next
        let touchStartY = 0;
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            const diff = touchStartY - e.changedTouches[0].clientY;
            if (diff > 100 && state.inCall) {
                nextPartner();
            }
        }, { passive: true });
        
        // Close modals on outside click
        document.addEventListener('click', (e) => {
            if (!el.giftPanel.contains(e.target) && e.target !== el.giftBtn) {
                el.giftPanel.classList.remove('active');
            }
        });
        
        // Keyboard shortcut
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (state.inCall) nextPartner();
                else if (state.searching) cancelSearch();
            }
        });
    }
    
    // Start
    init();
    </script>
    <!-- PWA Installation Button (immer sichtbar) -->
<div class="install-fab" id="installFab">
    <button class="install-fab-btn">
        <span>üì≤</span>
        <span class="install-text">App Installieren</span>
    </button>
</div>

<!-- Update Notification -->
<div class="update-notification" id="updateNotification">
    <div class="update-content">
        <span class="update-icon">üîÑ</span>
        <div class="update-text">
            <strong>Update verf√ºgbar</strong>
            <span>Neue Version von BrownTV ist da!</span>
        </div>
        <button class="update-btn" id="updateBtn">Jetzt aktualisieren</button>
    </div>
</div>

<style>
/* Install FAB */
.install-fab {
    position: fixed;
    bottom: 100px;
    right: 20px;
    z-index: 10000;
}

.install-fab-btn {
    background: linear-gradient(135deg, #e94560, #ff6b81);
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    color: white;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(233, 69, 96, 0.4);
    transition: all 0.3s;
    animation: pulseInstall 2s infinite;
}

@keyframes pulseInstall {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.install-fab-btn:hover {
    transform: translateY(-5px);
}

.install-text {
    white-space: nowrap;
}

@media (max-width: 768px) {
    .install-fab {
        bottom: 120px;
        right: 15px;
    }
    
    .install-text {
        display: none;
    }
    
    .install-fab-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        justify-content: center;
    }
}

/* Update Notification */
.update-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg-card);
    border: 2px solid var(--accent);
    border-radius: 15px;
    padding: 15px 20px;
    z-index: 10001;
    display: none;
    animation: slideDownUpdate 0.3s ease-out;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.update-notification.active {
    display: block;
}

@keyframes slideDownUpdate {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

.update-content {
    display: flex;
    align-items: center;
    gap: 15px;
}

.update-icon {
    font-size: 24px;
    animation: spin 2s linear infinite;
}

.update-text {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.update-text strong {
    color: var(--text);
    font-size: 14px;
}

.update-text span {
    color: var(--text-secondary);
    font-size: 12px;
}

.update-btn {
    background: var(--accent);
    border: none;
    border-radius: 10px;
    padding: 8px 16px;
    color: white;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
}

.update-btn:hover {
    background: #14b38a;
}

/* Dark mode for update */
@media (prefers-color-scheme: dark) {
    .update-notification {
        background: #1a1a2e;
        border-color: #16c79a;
    }
}
</style>

<script>
// Auto-update and install functionality
(function() {
    'use strict';
    
    // Check for updates
    const CURRENT_VERSION = '2.0.0';
    const UPDATE_CHECK_INTERVAL = 30 * 60 * 1000; // 30 minutes
    
    let deferredPrompt;
    let updateAvailable = false;
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js');
                console.log('Service Worker registered:', registration);
                
                // Check for updates
                registration.addEventListener('updatefound', () => {
                    const newWorker = registration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            showUpdateNotification();
                        }
                    });
                });
            } catch (error) {
                console.error('Service Worker registration failed:', error);
            }
        });
    }
    
    // PWA Install Prompt
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallButton();
        
        // Log install prompt
        console.log('Install prompt available');
    });
    
    // App installed event
    window.addEventListener('appinstalled', () => {
        console.log('App installed successfully');
        hideInstallButton();
        deferredPrompt = null;
        
        // Track installation
        if (typeof gtag !== 'undefined') {
            gtag('event', 'install', {
                'event_category': 'engagement',
                'event_label': 'pwa_install'
            });
        }
    });
    
    // Update check
    async function checkForUpdates() {
        try {
            const response = await fetch('/api/version');
            const data = await response.json();
            
            if (data.version !== CURRENT_VERSION) {
                showUpdateNotification();
                updateAvailable = true;
            }
        } catch (error) {
            console.error('Update check failed:', error);
        }
    }
    
    // Show install button
    function showInstallButton() {
        const installFab = document.getElementById('installFab');
        if (installFab) {
            installFab.style.display = 'block';
            
            // Add click handler
            const installBtn = installFab.querySelector('.install-fab-btn');
            installBtn.onclick = async () => {
                if (!deferredPrompt) {
                    // Show instructions
                    if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                        showIOSInstructions();
                    } else {
                        showInstallInstructions();
                    }
                    return;
                }
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted install');
                }
                
                deferredPrompt = null;
                hideInstallButton();
            };
        }
    }
    
    function hideInstallButton() {
        const installFab = document.getElementById('installFab');
        if (installFab) {
            installFab.style.display = 'none';
        }
    }
    
    function showUpdateNotification() {
        const updateNotif = document.getElementById('updateNotification');
        if (updateNotif) {
            updateNotif.classList.add('active');
            
            const updateBtn = document.getElementById('updateBtn');
            updateBtn.onclick = () => {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.update().then(() => {
                            window.location.reload();
                        });
                    });
                } else {
                    window.location.reload();
                }
            };
        }
    }
    
    function showIOSInstructions() {
        const modal = document.createElement('div');
        modal.className = 'ios-instructions-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <h3>üì± Auf iPhone/iPad installieren:</h3>
                <ol>
                    <li>Tippe auf das <strong>Teilen</strong> Symbol (Quadrat mit Pfeil)</li>
                    <li>Scrolle nach unten und w√§hle <strong>"Zum Home-Bildschirm"</strong></li>
                    <li>Tippe auf <strong>"Hinzuf√ºgen"</strong> oben rechts</li>
                    <li>BrownTV erscheint nun wie eine App!</li>
                </ol>
                <button class="close-instructions">Verstanden</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Add styles
        const style = document.createElement('style');
        style.textContent = `
            .ios-instructions-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 20000;
                padding: 20px;
            }
            
            .modal-content {
                background: var(--bg-card);
                border-radius: 20px;
                padding: 30px;
                max-width: 400px;
                width: 100%;
                animation: modalPop 0.3s ease-out;
            }
            
            @keyframes modalPop {
                from { opacity: 0; transform: scale(0.8); }
                to { opacity: 1; transform: scale(1); }
            }
            
            .modal-content h3 {
                color: var(--primary);
                margin-bottom: 20px;
                font-size: 18px;
            }
            
            .modal-content ol {
                padding-left: 20px;
                margin-bottom: 25px;
                color: var(--text);
                line-height: 1.8;
            }
            
            .modal-content ol li {
                margin-bottom: 10px;
            }
            
            .modal-content ol li strong {
                color: var(--primary-light);
            }
            
            .close-instructions {
                width: 100%;
                padding: 15px;
                background: var(--primary);
                border: none;
                border-radius: 12px;
                color: white;
                font-weight: 600;
                font-size: 16px;
                cursor: pointer;
            }
        `;
        document.head.appendChild(style);
        
        modal.querySelector('.close-instructions').onclick = () => {
            modal.remove();
            style.remove();
        };
    }
    
    function showInstallInstructions() {
        toast('Zum Installieren: Men√º ‚Üí "App installieren" oder "Zum Startbildschirm hinzuf√ºgen" w√§hlen');
    }
    
    // Periodic update check
    setInterval(checkForUpdates, UPDATE_CHECK_INTERVAL);
    
    // Initial update check
    setTimeout(checkForUpdates, 5000);
    
    // Offline detection
    window.addEventListener('online', () => {
        toast('Wieder online', 'success');
        checkForUpdates();
    });
    
    window.addEventListener('offline', () => {
        toast('Du bist offline', 'error');
    });
})();
</script>
</body>
</html>
