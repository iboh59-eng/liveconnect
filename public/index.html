<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="LiveConnect - Random Video Chat">
    <link rel="manifest" href="data:application/json,{'name':'LiveConnect','short_name':'LiveConnect','start_url':'/','display':'standalone','background_color':'%230a0a0f','theme_color':'%23ff2d55'}">
    <title>LiveConnect</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --primary: #ff2d55;
            --primary-glow: rgba(255,45,85,0.4);
            --secondary: #00f5d4;
            --bg: #0a0a0f;
            --card: #13131a;
            --elevated: #1c1c26;
            --text: #fff;
            --text2: #8a8a9a;
            --border: rgba(255,255,255,0.08);
            --success: #30d158;
            --danger: #ff453a;
            --warning: #ff9f0a;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        
        html, body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }
        
        /* App Container */
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            height: 100dvh;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(10,10,15,0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .logo-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 11px;
            color: var(--text2);
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .stat-dot {
            width: 6px;
            height: 6px;
            background: var(--secondary);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }
        
        .stat b {
            color: var(--text);
            font-weight: 600;
        }
        
        .menu-btn {
            width: 32px;
            height: 32px;
            background: var(--elevated);
            border: none;
            border-radius: 8px;
            color: var(--text);
            font-size: 16px;
            cursor: pointer;
        }
        
        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }
        
        /* Video Area */
        .video-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 8px;
            min-height: 0;
        }
        
        @media (min-width: 700px) {
            .video-area {
                flex-direction: row;
            }
        }
        
        .video-box {
            flex: 1;
            position: relative;
            background: var(--card);
            border-radius: 16px;
            overflow: hidden;
            min-height: 0;
        }
        
        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-box.local video {
            transform: scaleX(-1);
        }
        
        .video-box.connected {
            box-shadow: 0 0 0 2px var(--secondary), 0 0 30px rgba(0,245,212,0.2);
        }
        
        .video-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            padding: 4px 10px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .video-placeholder {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: linear-gradient(180deg, var(--card), var(--elevated));
        }
        
        .placeholder-icon {
            width: 60px;
            height: 60px;
            background: var(--elevated);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border: 2px solid var(--border);
        }
        
        .placeholder-text {
            font-size: 13px;
            color: var(--text2);
            text-align: center;
            padding: 0 20px;
        }
        
        /* Mini local video (mobile overlay) */
        .mini-local {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 100px;
            height: 140px;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--border);
            z-index: 5;
            display: none;
            cursor: move;
            touch-action: none;
        }
        
        .mini-local.active {
            display: block;
        }
        
        .mini-local video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        /* Video Controls Overlay */
        .video-controls {
            position: absolute;
            top: 8px;
            left: 8px;
            display: flex;
            gap: 6px;
            z-index: 5;
        }
        
        .video-ctrl-btn {
            width: 36px;
            height: 36px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.15s;
        }
        
        .video-ctrl-btn:active {
            transform: scale(0.9);
        }
        
        .video-ctrl-btn.active {
            background: var(--primary);
        }
        
        /* Searching Overlay */
        .searching {
            position: absolute;
            inset: 0;
            background: rgba(10,10,15,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 20;
        }
        
        .searching.active {
            display: flex;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .searching-text {
            font-size: 15px;
            color: var(--text2);
        }
        
        .cancel-btn {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text2);
            font-size: 13px;
            cursor: pointer;
        }
        
        /* Controls Bar */
        .controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: var(--card);
            border-top: 1px solid var(--border);
        }
        
        .ctrl-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--elevated);
            color: var(--text);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ctrl-btn:active {
            transform: scale(0.9);
        }
        
        .ctrl-btn:disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .ctrl-btn.muted {
            background: rgba(255,69,58,0.2);
            color: var(--danger);
        }
        
        .ctrl-btn.primary {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            font-size: 24px;
            box-shadow: 0 4px 20px var(--primary-glow);
        }
        
        .ctrl-btn.danger {
            background: var(--danger);
        }
        
        .ctrl-btn.success {
            background: var(--success);
        }
        
        .ctrl-btn.like {
            background: var(--elevated);
        }
        
        .ctrl-btn.like.liked {
            background: #ff2d55;
            animation: heartBeat 0.3s;
        }
        
        @keyframes heartBeat {
            50% { transform: scale(1.3); }
        }
        
        /* Action Buttons (Gifts, Like, etc) */
        .action-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 8px 12px;
            display: none;
        }
        
        .action-bar.active {
            display: flex;
        }
        
        .action-btn {
            padding: 6px 14px;
            background: var(--elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        /* Gift Picker */
        .gift-picker {
            position: absolute;
            bottom: 140px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            display: none;
            gap: 8px;
            z-index: 30;
        }
        
        .gift-picker.active {
            display: flex;
        }
        
        .gift-btn {
            width: 44px;
            height: 44px;
            background: var(--elevated);
            border: none;
            border-radius: 12px;
            font-size: 22px;
            cursor: pointer;
            transition: transform 0.15s;
        }
        
        .gift-btn:active {
            transform: scale(1.2);
        }
        
        /* Received Gift Animation */
        .gift-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            z-index: 100;
            animation: giftPop 1s ease-out forwards;
            pointer-events: none;
        }
        
        @keyframes giftPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            100% { transform: translate(-50%, -100%) scale(1); opacity: 0; }
        }
        
        /* Chat */
        .chat-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-height: 50%;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            z-index: 15;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            mask-image: linear-gradient(transparent, black 20%);
            -webkit-mask-image: linear-gradient(transparent, black 20%);
        }
        
        .chat-msg {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 13px;
            animation: msgIn 0.2s ease-out;
            pointer-events: auto;
        }
        
        @keyframes msgIn {
            from { opacity: 0; transform: translateY(10px); }
        }
        
        .chat-msg.sent {
            align-self: flex-end;
            background: var(--primary);
            border-bottom-right-radius: 4px;
        }
        
        .chat-msg.received {
            align-self: flex-start;
            background: var(--elevated);
            border-bottom-left-radius: 4px;
        }
        
        .chat-msg.system {
            align-self: center;
            background: rgba(0,0,0,0.5);
            font-size: 11px;
            color: var(--text2);
        }
        
        .chat-input-area {
            padding: 8px;
            pointer-events: auto;
        }
        
        .chat-input-wrap {
            display: flex;
            gap: 8px;
            padding: 6px;
            background: var(--card);
            border-radius: 24px;
            border: 1px solid var(--border);
        }
        
        .chat-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 14px;
            padding: 0 10px;
        }
        
        .chat-input::placeholder {
            color: var(--text2);
        }
        
        .chat-send {
            width: 36px;
            height: 36px;
            background: var(--primary);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        
        .chat-send:disabled {
            opacity: 0.5;
        }
        
        /* Quick Replies */
        .quick-replies {
            display: flex;
            gap: 6px;
            padding: 0 8px 8px;
            overflow-x: auto;
            pointer-events: auto;
        }
        
        .quick-replies::-webkit-scrollbar {
            display: none;
        }
        
        .quick-reply {
            padding: 6px 12px;
            background: var(--elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text);
            font-size: 12px;
            white-space: nowrap;
            cursor: pointer;
        }
        
        /* Start Screen */
        .start-screen {
            position: fixed;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        
        .start-screen.hidden {
            display: none;
        }
        
        .start-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin-bottom: 20px;
            box-shadow: 0 20px 50px var(--primary-glow);
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            50% { transform: translateY(-10px); }
        }
        
        .start-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .start-subtitle {
            font-size: 14px;
            color: var(--text2);
            text-align: center;
            margin-bottom: 30px;
            max-width: 280px;
        }
        
        .start-btn {
            padding: 14px 40px;
            background: linear-gradient(135deg, var(--primary), #ff6b35);
            border: none;
            border-radius: 30px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 10px 30px var(--primary-glow);
        }
        
        .start-btn:active {
            transform: scale(0.95);
        }
        
        /* Settings */
        .settings-panel {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 90;
            display: none;
            flex-direction: column;
            padding-top: var(--safe-top);
        }
        
        .settings-panel.active {
            display: flex;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .settings-header h2 {
            font-size: 18px;
        }
        
        .settings-close {
            width: 36px;
            height: 36px;
            background: var(--elevated);
            border: none;
            border-radius: 10px;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .setting-group {
            margin-bottom: 24px;
        }
        
        .setting-label {
            font-size: 12px;
            color: var(--text2);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .setting-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .setting-option {
            padding: 10px 16px;
            background: var(--elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
        }
        
        .setting-option.selected {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .settings-save {
            margin: 16px;
            padding: 14px;
            background: var(--primary);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Match Animation */
        .match-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 80;
        }
        
        .match-overlay.active {
            display: flex;
        }
        
        .match-content {
            text-align: center;
            animation: matchPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes matchPop {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        
        .match-emoji {
            font-size: 60px;
            margin-bottom: 12px;
            animation: bounce 0.6s infinite;
        }
        
        @keyframes bounce {
            50% { transform: scale(1.1); }
        }
        
        .match-text {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--secondary), #00bbf9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .match-info {
            font-size: 15px;
            color: var(--text2);
            margin-top: 8px;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .toast {
            padding: 10px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 13px;
            animation: toastIn 0.3s;
            white-space: nowrap;
        }
        
        @keyframes toastIn {
            from { opacity: 0; transform: translateY(-20px); }
        }
        
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        
        /* Swipe Hint */
        .swipe-hint {
            position: absolute;
            bottom: 20%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0,0,0,0.7);
            border-radius: 20px;
            font-size: 12px;
            color: var(--text2);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .swipe-hint.show {
            opacity: 1;
        }
        
        /* Desktop adjustments */
        @media (min-width: 700px) {
            .mini-local { display: none !important; }
            .video-box.local { display: flex !important; }
            
            .chat-container {
                position: absolute;
                top: 0;
                left: auto;
                right: 0;
                bottom: 0;
                width: 300px;
                max-height: none;
                background: var(--card);
                border-left: 1px solid var(--border);
                pointer-events: auto;
            }
            
            .chat-messages {
                mask-image: none;
                -webkit-mask-image: none;
            }
            
            .video-area {
                margin-right: 300px;
            }
        }
        
        /* Landscape mobile */
        @media (max-height: 500px) and (orientation: landscape) {
            .header { padding: 4px 12px; }
            .controls { padding: 8px; }
            .ctrl-btn { width: 42px; height: 42px; font-size: 18px; }
            .ctrl-btn.primary { width: 50px; height: 50px; }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toasts"></div>
    
    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-logo">üé•</div>
        <h1 class="start-title">LiveConnect</h1>
        <p class="start-subtitle">Video-Chat mit echten Menschen weltweit. Kostenlos und sicher.</p>
        <button class="start-btn" id="startBtn">Jetzt starten</button>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>‚öôÔ∏è Einstellungen</h2>
            <button class="settings-close" id="settingsClose">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="setting-group">
                <div class="setting-label">Dein Geschlecht</div>
                <div class="setting-options">
                    <button class="setting-option" data-gender="male">üë® M√§nnlich</button>
                    <button class="setting-option" data-gender="female">üë© Weiblich</button>
                    <button class="setting-option selected" data-gender="">üôÇ Egal</button>
                </div>
            </div>
            <div class="setting-group">
                <div class="setting-label">Partner suchen</div>
                <div class="setting-options">
                    <button class="setting-option filter-option selected" data-filter="">üåç Alle</button>
                    <button class="setting-option filter-option" data-filter="europe">üá™üá∫ Europa</button>
                    <button class="setting-option filter-option" data-filter="americas">üåé Amerika</button>
                    <button class="setting-option filter-option" data-filter="asia">üåè Asien</button>
                </div>
            </div>
        </div>
        <button class="settings-save" id="settingsSave">Speichern</button>
    </div>
    
    <!-- Match Overlay -->
    <div class="match-overlay" id="matchOverlay">
        <div class="match-content">
            <div class="match-emoji">üéâ</div>
            <div class="match-text">Partner gefunden!</div>
            <div class="match-info" id="matchInfo"></div>
        </div>
    </div>
    
    <!-- Gift Picker -->
    <div class="gift-picker" id="giftPicker">
        <button class="gift-btn" data-gift="‚ù§Ô∏è">‚ù§Ô∏è</button>
        <button class="gift-btn" data-gift="üíé">üíé</button>
        <button class="gift-btn" data-gift="üåπ">üåπ</button>
        <button class="gift-btn" data-gift="üéÅ">üéÅ</button>
        <button class="gift-btn" data-gift="‚≠ê">‚≠ê</button>
        <button class="gift-btn" data-gift="üî•">üî•</button>
    </div>
    
    <!-- Main App -->
    <div class="app">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üé•</div>
                <span>LiveConnect</span>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-dot"></div>
                    <span><b id="onlineCount">0</b> online</span>
                </div>
            </div>
            <button class="menu-btn" id="menuBtn">‚öôÔ∏è</button>
        </header>
        
        <main class="main">
            <div class="video-area">
                <!-- Local Video (Desktop) -->
                <div class="video-box local" id="localBox">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-placeholder" id="localPlaceholder">
                        <div class="placeholder-icon">üë§</div>
                        <div class="placeholder-text">Kamera aktivieren...</div>
                    </div>
                    <div class="video-label">
                        <span id="localFlag">üåç</span>
                        <span id="localName">Du</span>
                    </div>
                    <div class="video-controls">
                        <button class="video-ctrl-btn" id="flipCamBtn">üîÑ</button>
                    </div>
                </div>
                
                <!-- Remote Video -->
                <div class="video-box" id="remoteBox">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-placeholder" id="remotePlaceholder">
                        <div class="placeholder-icon">üîç</div>
                        <div class="placeholder-text">Tippe Start um jemanden zu finden</div>
                    </div>
                    <div class="video-label" id="remoteLabel" style="display:none">
                        <span id="remoteFlag">üåç</span>
                        <span id="remoteName">Partner</span>
                    </div>
                    
                    <!-- Mini Local Video (Mobile) -->
                    <div class="mini-local" id="miniLocal">
                        <video id="miniLocalVideo" autoplay muted playsinline></video>
                    </div>
                    
                    <!-- Searching Overlay -->
                    <div class="searching" id="searching">
                        <div class="spinner"></div>
                        <div class="searching-text">Suche Partner...</div>
                        <button class="cancel-btn" id="cancelBtn">Abbrechen</button>
                    </div>
                    
                    <!-- Chat Overlay -->
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages" id="chatMessages"></div>
                        <div class="quick-replies" id="quickReplies">
                            <button class="quick-reply" data-msg="Hi! üëã">Hi! üëã</button>
                            <button class="quick-reply" data-msg="Woher kommst du?">Woher?</button>
                            <button class="quick-reply" data-msg="üòä">üòä</button>
                            <button class="quick-reply" data-msg="üëç">üëç</button>
                            <button class="quick-reply" data-msg="Wie geht's?">Wie geht's?</button>
                        </div>
                        <div class="chat-input-area">
                            <div class="chat-input-wrap">
                                <input type="text" class="chat-input" id="chatInput" placeholder="Nachricht..." maxlength="500" disabled>
                                <button class="chat-send" id="chatSend" disabled>‚û§</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="swipe-hint" id="swipeHint">üëÜ Swipe f√ºr n√§chsten Partner</div>
                </div>
            </div>
            
            <!-- Action Bar -->
            <div class="action-bar" id="actionBar">
                <button class="action-btn" id="likeBtn">‚ù§Ô∏è Like</button>
                <button class="action-btn" id="giftBtn">üéÅ Geschenk</button>
                <button class="action-btn" id="addFriendBtn">üë• Freund</button>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <button class="ctrl-btn" id="micBtn" disabled>üé§</button>
                <button class="ctrl-btn" id="camBtn" disabled>üìπ</button>
                <button class="ctrl-btn primary success" id="startCallBtn">‚ñ∂Ô∏è</button>
                <button class="ctrl-btn primary" id="nextBtn" style="display:none">‚è≠Ô∏è</button>
                <button class="ctrl-btn danger" id="endBtn" style="display:none">‚úï</button>
                <button class="ctrl-btn" id="reportBtn" disabled>üö©</button>
            </div>
        </main>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ============================================
        // CONFIG & STATE
        // ============================================
        
        const ICE_SERVERS = [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' },
            { urls: 'turn:openrelay.metered.ca:443', username: 'openrelayproject', credential: 'openrelayproject' }
        ];
        
        const state = {
            socket: null,
            localStream: null,
            pc: null,
            connected: false,
            inCall: false,
            searching: false,
            micOn: true,
            camOn: true,
            user: null,
            partner: null,
            facingMode: 'user',
            filter: {},
            gender: null,
            liked: false
        };
        
        // ============================================
        // DOM ELEMENTS
        // ============================================
        
        const $ = id => document.getElementById(id);
        const el = {
            startScreen: $('startScreen'),
            startBtn: $('startBtn'),
            settingsPanel: $('settingsPanel'),
            settingsClose: $('settingsClose'),
            settingsSave: $('settingsSave'),
            menuBtn: $('menuBtn'),
            matchOverlay: $('matchOverlay'),
            matchInfo: $('matchInfo'),
            giftPicker: $('giftPicker'),
            localVideo: $('localVideo'),
            remoteVideo: $('remoteVideo'),
            miniLocalVideo: $('miniLocalVideo'),
            localPlaceholder: $('localPlaceholder'),
            remotePlaceholder: $('remotePlaceholder'),
            localBox: $('localBox'),
            remoteBox: $('remoteBox'),
            miniLocal: $('miniLocal'),
            localFlag: $('localFlag'),
            localName: $('localName'),
            remoteLabel: $('remoteLabel'),
            remoteFlag: $('remoteFlag'),
            remoteName: $('remoteName'),
            searching: $('searching'),
            cancelBtn: $('cancelBtn'),
            chatMessages: $('chatMessages'),
            chatInput: $('chatInput'),
            chatSend: $('chatSend'),
            quickReplies: $('quickReplies'),
            actionBar: $('actionBar'),
            likeBtn: $('likeBtn'),
            giftBtn: $('giftBtn'),
            addFriendBtn: $('addFriendBtn'),
            micBtn: $('micBtn'),
            camBtn: $('camBtn'),
            startCallBtn: $('startCallBtn'),
            nextBtn: $('nextBtn'),
            endBtn: $('endBtn'),
            reportBtn: $('reportBtn'),
            flipCamBtn: $('flipCamBtn'),
            onlineCount: $('onlineCount'),
            toasts: $('toasts'),
            swipeHint: $('swipeHint')
        };
        
        // ============================================
        // UTILITIES
        // ============================================
        
        function toast(msg, type = '') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.textContent = msg;
            el.toasts.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        
        function showGiftAnimation(gift) {
            const g = document.createElement('div');
            g.className = 'gift-animation';
            g.textContent = gift;
            document.body.appendChild(g);
            setTimeout(() => g.remove(), 1000);
        }
        
        function addMsg(text, type) {
            const m = document.createElement('div');
            m.className = `chat-msg ${type}`;
            m.textContent = text;
            el.chatMessages.appendChild(m);
            el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
        }
        
        function clearChat() {
            el.chatMessages.innerHTML = '';
        }
        
        function enableChat(on) {
            el.chatInput.disabled = !on;
            el.chatSend.disabled = !on;
        }
        
        function updateUI(inCall) {
            el.startCallBtn.style.display = inCall ? 'none' : 'flex';
            el.nextBtn.style.display = inCall ? 'flex' : 'none';
            el.endBtn.style.display = inCall ? 'flex' : 'none';
            el.reportBtn.disabled = !inCall;
            el.actionBar.classList.toggle('active', inCall);
            el.miniLocal.classList.toggle('active', inCall && window.innerWidth < 700);
            
            if (inCall) {
                el.localBox.style.display = window.innerWidth < 700 ? 'none' : '';
            } else {
                el.localBox.style.display = '';
            }
        }
        
        // ============================================
        // MEDIA
        // ============================================
        
        async function getMedia() {
            try {
                state.localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: state.facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: { echoCancellation: true, noiseSuppression: true }
                });
                
                el.localVideo.srcObject = state.localStream;
                el.miniLocalVideo.srcObject = state.localStream;
                el.localPlaceholder.style.display = 'none';
                el.micBtn.disabled = false;
                el.camBtn.disabled = false;
                
                return true;
            } catch (e) {
                console.error('Media error:', e);
                toast('Kamera-Zugriff fehlgeschlagen', 'error');
                el.localPlaceholder.querySelector('.placeholder-text').textContent = 'Kamera blockiert';
                return false;
            }
        }
        
        async function flipCamera() {
            if (!state.localStream) return;
            
            state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
            
            state.localStream.getTracks().forEach(t => t.stop());
            
            try {
                state.localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: state.facingMode },
                    audio: true
                });
                
                el.localVideo.srcObject = state.localStream;
                el.miniLocalVideo.srcObject = state.localStream;
                
                // Replace tracks in peer connection
                if (state.pc) {
                    const senders = state.pc.getSenders();
                    const videoTrack = state.localStream.getVideoTracks()[0];
                    const audioTrack = state.localStream.getAudioTracks()[0];
                    
                    senders.forEach(sender => {
                        if (sender.track?.kind === 'video' && videoTrack) {
                            sender.replaceTrack(videoTrack);
                        } else if (sender.track?.kind === 'audio' && audioTrack) {
                            sender.replaceTrack(audioTrack);
                        }
                    });
                }
            } catch (e) {
                console.error('Flip camera error:', e);
            }
        }
        
        // ============================================
        // WEBRTC
        // ============================================
        
        function createPC() {
            const pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });
            
            state.localStream?.getTracks().forEach(t => pc.addTrack(t, state.localStream));
            
            pc.ontrack = (e) => {
                el.remoteVideo.srcObject = e.streams[0];
                el.remotePlaceholder.style.display = 'none';
                el.remoteBox.classList.add('connected');
            };
            
            pc.onicecandidate = (e) => {
                if (e.candidate) {
                    state.socket.emit('ice-candidate', { candidate: e.candidate });
                }
            };
            
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') {
                    toast('Verbunden!', 'success');
                } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    handlePartnerLeft();
                }
            };
            
            state.pc = pc;
            return pc;
        }
        
        async function createOffer() {
            if (!state.pc) createPC();
            const offer = await state.pc.createOffer();
            await state.pc.setLocalDescription(offer);
            state.socket.emit('webrtc-offer', { offer });
        }
        
        async function handleOffer(offer) {
            if (!state.pc) createPC();
            await state.pc.setRemoteDescription(offer);
            const answer = await state.pc.createAnswer();
            await state.pc.setLocalDescription(answer);
            state.socket.emit('webrtc-answer', { answer });
        }
        
        async function handleAnswer(answer) {
            await state.pc?.setRemoteDescription(answer);
        }
        
        async function handleIce(candidate) {
            await state.pc?.addIceCandidate(candidate);
        }
        
        function closePC() {
            state.pc?.close();
            state.pc = null;
            el.remoteVideo.srcObject = null;
            el.remoteBox.classList.remove('connected');
        }
        
        // ============================================
        // SOCKET
        // ============================================
        
        function initSocket() {
            state.socket = io();
            
            state.socket.on('connect', () => {
                state.connected = true;
                toast('Verbunden', 'success');
            });
            
            state.socket.on('disconnect', () => {
                state.connected = false;
                toast('Verbindung verloren', 'error');
            });
            
            state.socket.on('user-info', (u) => {
                state.user = u;
                el.localFlag.textContent = u.country.code;
                el.localName.textContent = u.name;
            });
            
            state.socket.on('stats', (s) => {
                el.onlineCount.textContent = s.online;
            });
            
            state.socket.on('searching', () => {
                state.searching = true;
                el.searching.classList.add('active');
            });
            
            state.socket.on('match-found', (data) => {
                state.searching = false;
                state.inCall = true;
                state.partner = data;
                state.liked = false;
                
                el.searching.classList.remove('active');
                el.matchInfo.textContent = `${data.partnerCountry.code} ${data.partnerName}`;
                el.matchOverlay.classList.add('active');
                
                setTimeout(() => {
                    el.matchOverlay.classList.remove('active');
                    el.remoteFlag.textContent = data.partnerCountry.code;
                    el.remoteName.textContent = data.partnerName;
                    el.remoteLabel.style.display = 'flex';
                    
                    clearChat();
                    addMsg(`Verbunden mit ${data.partnerName}`, 'system');
                    enableChat(true);
                    updateUI(true);
                    
                    createPC();
                    if (data.isInitiator) createOffer();
                    
                    // Show swipe hint on mobile
                    if (window.innerWidth < 700) {
                        el.swipeHint.classList.add('show');
                        setTimeout(() => el.swipeHint.classList.remove('show'), 3000);
                    }
                }, 1200);
            });
            
            state.socket.on('partner-left', handlePartnerLeft);
            
            state.socket.on('ready-for-next', () => {
                state.socket.emit('find-match', state.filter);
            });
            
            state.socket.on('webrtc-offer', (d) => handleOffer(d.offer));
            state.socket.on('webrtc-answer', (d) => handleAnswer(d.answer));
            state.socket.on('ice-candidate', (d) => handleIce(d.candidate));
            
            state.socket.on('chat-message', (d) => addMsg(d.message, 'received'));
            state.socket.on('partner-typing', () => {});
            
            state.socket.on('received-like', () => {
                toast('‚ù§Ô∏è Du hast ein Like bekommen!', 'success');
            });
            
            state.socket.on('received-gift', (d) => {
                showGiftAnimation(d.gift);
                toast(`${d.gift} Geschenk von ${d.from}!`, 'success');
            });
            
            state.socket.on('friend-request', (d) => {
                if (confirm(`${d.from} m√∂chte dein Freund sein!`)) {
                    state.socket.emit('accept-friend', { fromId: d.fromId });
                    toast('Freund hinzugef√ºgt!', 'success');
                }
            });
            
            state.socket.on('friend-accepted', () => {
                toast('Freundschaft best√§tigt!', 'success');
            });
        }
        
        function handlePartnerLeft() {
            toast('Partner hat verlassen');
            resetCall();
            addMsg('Partner hat den Chat verlassen', 'system');
        }
        
        function resetCall() {
            state.inCall = false;
            state.searching = false;
            state.partner = null;
            state.liked = false;
            
            closePC();
            
            el.searching.classList.remove('active');
            el.remotePlaceholder.style.display = 'flex';
            el.remoteLabel.style.display = 'none';
            el.giftPicker.classList.remove('active');
            el.likeBtn.classList.remove('liked');
            el.likeBtn.innerHTML = '‚ù§Ô∏è Like';
            
            enableChat(false);
            updateUI(false);
        }
        
        // ============================================
        // EVENTS
        // ============================================
        
        function init() {
            // Start
            el.startBtn.onclick = async () => {
                el.startScreen.classList.add('hidden');
                if (await getMedia()) {
                    initSocket();
                }
            };
            
            // Settings
            el.menuBtn.onclick = () => el.settingsPanel.classList.add('active');
            el.settingsClose.onclick = () => el.settingsPanel.classList.remove('active');
            
            document.querySelectorAll('[data-gender]').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('[data-gender]').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.gender = btn.dataset.gender || null;
                };
            });
            
            document.querySelectorAll('.filter-option').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.filter-option').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.filter = btn.dataset.filter ? { region: btn.dataset.filter } : {};
                };
            });
            
            el.settingsSave.onclick = () => {
                state.socket?.emit('set-preferences', { gender: state.gender, filter: state.filter });
                el.settingsPanel.classList.remove('active');
                toast('Gespeichert');
            };
            
            // Controls
            el.micBtn.onclick = () => {
                state.micOn = !state.micOn;
                state.localStream?.getAudioTracks().forEach(t => t.enabled = state.micOn);
                el.micBtn.classList.toggle('muted', !state.micOn);
                el.micBtn.textContent = state.micOn ? 'üé§' : 'üîá';
            };
            
            el.camBtn.onclick = () => {
                state.camOn = !state.camOn;
                state.localStream?.getVideoTracks().forEach(t => t.enabled = state.camOn);
                el.camBtn.classList.toggle('muted', !state.camOn);
                el.camBtn.textContent = state.camOn ? 'üìπ' : 'üì∑';
            };
            
            el.flipCamBtn.onclick = flipCamera;
            
            el.startCallBtn.onclick = () => {
                if (!state.connected) return toast('Nicht verbunden', 'error');
                state.socket.emit('find-match', state.filter);
            };
            
            el.nextBtn.onclick = () => state.socket.emit('next-partner');
            
            el.endBtn.onclick = () => {
                state.socket.emit('end-call');
                resetCall();
            };
            
            el.cancelBtn.onclick = () => {
                state.socket.emit('cancel-search');
                state.searching = false;
                el.searching.classList.remove('active');
            };
            
            el.reportBtn.onclick = () => {
                if (confirm('Benutzer melden?')) {
                    state.socket.emit('report-user', {});
                    state.socket.emit('next-partner');
                }
            };
            
            // Chat
            el.chatSend.onclick = sendMsg;
            el.chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendMsg(); };
            
            el.quickReplies.querySelectorAll('.quick-reply').forEach(btn => {
                btn.onclick = () => {
                    if (state.inCall) {
                        el.chatInput.value = btn.dataset.msg;
                        sendMsg();
                    }
                };
            });
            
            // Actions
            el.likeBtn.onclick = () => {
                if (state.inCall && !state.liked) {
                    state.socket.emit('like-partner');
                    state.liked = true;
                    el.likeBtn.classList.add('liked');
                    el.likeBtn.innerHTML = '‚ù§Ô∏è Liked!';
                }
            };
            
            el.giftBtn.onclick = () => {
                el.giftPicker.classList.toggle('active');
            };
            
            el.giftPicker.querySelectorAll('.gift-btn').forEach(btn => {
                btn.onclick = () => {
                    if (state.inCall) {
                        state.socket.emit('send-gift', { gift: btn.dataset.gift });
                        el.giftPicker.classList.remove('active');
                    }
                };
            });
            
            el.addFriendBtn.onclick = () => {
                if (state.inCall) {
                    state.socket.emit('add-friend');
                    toast('Freundschaftsanfrage gesendet');
                }
            };
            
            // Swipe gesture for next
            let touchStartY = 0;
            el.remoteBox.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            el.remoteBox.addEventListener('touchend', (e) => {
                const diff = touchStartY - e.changedTouches[0].clientY;
                if (diff > 100 && state.inCall) {
                    state.socket.emit('next-partner');
                }
            }, { passive: true });
            
            // Keyboard
            document.onkeydown = (e) => {
                if (e.key === 'Escape' && state.inCall) {
                    state.socket.emit('next-partner');
                }
            };
            
            // Close gift picker on outside click
            document.onclick = (e) => {
                if (!el.giftPicker.contains(e.target) && e.target !== el.giftBtn) {
                    el.giftPicker.classList.remove('active');
                }
            };
        }
        
        function sendMsg() {
            const msg = el.chatInput.value.trim();
            if (msg && state.inCall) {
                addMsg(msg, 'sent');
                state.socket.emit('chat-message', { message: msg });
                el.chatInput.value = '';
            }
        }
        
        init();
    </script>
</body>
</html>
