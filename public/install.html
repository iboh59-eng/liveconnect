<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrownTV Download</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f3460, #1a1a2e);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .download-container {
            max-width: 600px;
            width: 100%;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            padding: 50px 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
        }
        
        .app-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        h1 {
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #e94560, #ff6b81, #16c79a);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .version {
            color: #16c79a;
            font-weight: 600;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .download-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 40px 0;
        }
        
        .download-btn {
            padding: 20px;
            border-radius: 20px;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .download-btn:hover {
            transform: translateY(-5px);
        }
        
        .android-btn {
            background: linear-gradient(135deg, #3ddc84, #34a853);
            color: white;
        }
        
        .ios-btn {
            background: linear-gradient(135deg, #007aff, #5856d6);
            color: white;
        }
        
        .pwa-btn {
            background: linear-gradient(135deg, #e94560, #ff6b81);
            color: white;
        }
        
        .features-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 40px 0;
            text-align: left;
        }
        
        .feature-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #e94560;
        }
        
        .feature-item h3 {
            color: #ff6b81;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .feature-item p {
            color: #a0a0b0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .qr-section {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .qr-code {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            background: white;
            padding: 15px;
            border-radius: 15px;
        }
        
        @media (max-width: 768px) {
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .download-btn {
                padding: 18px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="download-container">
        <div class="app-icon">üì∫</div>
        <h1>BrownTV</h1>
        <div class="version">Version 2.0.0</div>
        
        <p style="color: #a0a0b0; line-height: 1.6; margin-bottom: 30px;">
            Die beste Video-Chat App weltweit. Installiere BrownTV auf deinem Ger√§t f√ºr die ultimative Erfahrung.
        </p>
        
        <div class="download-options">
            <button class="download-btn android-btn" onclick="downloadAndroid()">
                <span>üì±</span>
                <span>Android APK Download</span>
            </button>
            
            <button class="download-btn ios-btn" onclick="downloadIOS()">
                <span>üì±</span>
                <span>iOS App Store</span>
            </button>
            
            <button class="download-btn pwa-btn" onclick="installPWA()">
                <span>üåê</span>
                <span>Als Web-App installieren</span>
            </button>
        </div>
        
        <div class="features-grid">
            <div class="feature-item">
                <h3>üöÄ Sofortige Verbindung</h3>
                <p>Finde sofort Video-Chat Partner weltweit</p>
            </div>
            <div class="feature-item">
                <h3>üîê Sicher & Privat</h3>
                <p>Ende-zu-Ende verschl√ºsselte Gespr√§che</p>
            </div>
            <div class="feature-item">
                <h3>üåç 150+ L√§nder</h3>
                <p>Verbinde dich mit Menschen aus aller Welt</p>
            </div>
            <div class="feature-item">
                <h3>üí¨ Live √úbersetzung</h3>
                <p>Automatische Sprach√ºbersetzung im Chat</p>
            </div>
        </div>
        
        <div class="qr-section">
            <p style="color: #a0a0b0; margin-bottom: 20px;">Scan zum Installieren:</p>
            <div class="qr-code" id="qrCode">
                <!-- QR Code wird hier generiert -->
                <div style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #333; font-size: 12px; text-align: center;">
                    QR Code f√ºr: https://browntv.app
                </div>
            </div>
        </div>
    </div>
    
    <script>
    function downloadAndroid() {
        // In production, link to actual APK
        window.open('https://github.com/your-repo/browntv/releases/latest/download/browntv.apk', '_blank');
        showToast('Android Download gestartet');
    }
    
    function downloadIOS() {
        // In production, link to App Store
        window.open('https://apps.apple.com/app/browntv-video-chat/idYOUR_APP_ID', '_blank');
        showToast('Weiterleitung zum App Store');
    }
    
    function installPWA() {
        if ('serviceWorker' in navigator && 'BeforeInstallPromptEvent' in window) {
            // Trigger PWA install prompt
            window.dispatchEvent(new Event('beforeinstallprompt'));
            
            // Redirect to install prompt page
            setTimeout(() => {
                window.location.href = '/install-prompt';
            }, 500);
        } else {
            showToast('Browser unterst√ºtzt PWA Installation nicht. Nutze Chrome oder Safari.');
        }
    }
    
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #e94560;
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: 500;
            z-index: 10000;
            animation: slideUp 0.3s ease-out;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideDown 0.3s ease-out forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
        
        // Add keyframes
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                to { opacity: 1; transform: translateX(-50%) translateY(0); }
            }
            @keyframes slideDown {
                from { opacity: 1; transform: translateX(-50%) translateY(0); }
                to { opacity: 0; transform: translateX(-50%) translateY(20px); }
            }
        `;
        document.head.appendChild(style);
    }
    
    // Generate QR code
    function generateQRCode() {
        const currentUrl = window.location.origin;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=170x170&data=${encodeURIComponent(currentUrl)}`;
        
        document.getElementById('qrCode').innerHTML = `
            <img src="${qrUrl}" alt="QR Code" style="width:100%;height:100%;border-radius:10px;">
        `;
    }
    
    // Initialize
    window.addEventListener('DOMContentLoaded', generateQRCode);
    // ============================================
// ENHANCED MATCHMAKING SYSTEM
// ============================================

const state = {
  socket: null,
  user: null,
  partner: null,
  inCall: false,
  searching: false,
  matchmakingQueue: null,
  filters: {
    gender: 'all',
    ageRange: [18, 35],
    country: 'all',
    interests: []
  }
};

// Initialize Socket with better connection
function initSocket() {
  // Auto-reconnect with exponential backoff
  let reconnectAttempts = 0;
  const maxReconnectDelay = 10000;
  
  function connect() {
    state.socket = io({
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      timeout: 20000
    });
    
    setupSocketEvents();
  }
  
  connect();
}

// Setup all socket events
function setupSocketEvents() {
  const socket = state.socket;
  
  // Connection events
  socket.on('connect', () => {
    console.log('Connected to server');
    reconnectAttempts = 0;
    showToast('‚úÖ Verbunden mit BrownTV Server');
    
    // Send user data if exists
    if (state.user) {
      socket.emit('update-profile', state.user);
    }
  });
  
  socket.on('disconnect', (reason) => {
    console.log('Disconnected:', reason);
    if (reason === 'io server disconnect') {
      // Server initiated disconnect, try to reconnect
      socket.connect();
    }
  });
  
  socket.on('connect_error', (error) => {
    console.error('Connection error:', error);
    reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), maxReconnectDelay);
    
    showToast(`‚ö†Ô∏è Verbindung fehlgeschlagen. Versuche erneut in ${delay/1000}s...`);
    
    setTimeout(() => {
      if (!socket.connected) {
        socket.connect();
      }
    }, delay);
  });
  
  // User initialization
  socket.on('init', (data) => {
    console.log('Initialized:', data);
    state.user = data.user;
    updateUserDisplay();
    
    // Check for other online users
    checkOnlineUsers();
  });
  
  // Matchmaking events
  socket.on('searching', (data) => {
    state.searching = true;
    showSearchingScreen(data);
  });
  
  socket.on('match-found', (data) => {
    console.log('Match found!', data);
    state.searching = false;
    state.inCall = true;
    state.partner = data.partner;
    
    showMatchFound(data);
    startWebRTCConnection(data.isInitiator);
  });
  
  socket.on('partner-disconnected', () => {
    endCall('Partner disconnected');
  });
  
  socket.on('partner-skipped', () => {
    endCall('Partner skipped');
    showToast('‚è≠Ô∏è Partner hat weitergewechselt');
  });
  
  // Real-time stats
  socket.on('stats', (data) => {
    updateStatsDisplay(data);
  });
  
  // Friend requests
  socket.on('friend-request', (data) => {
    showFriendRequest(data);
  });
  
  // Gift received
  socket.on('receive-gift', (data) => {
    showGiftAnimation(data);
  });
}

// ============================================
// AZAR-STYLE MATCHMAKING FUNCTIONS
// ============================================

function startSearch(filters = {}) {
  if (!state.socket || !state.socket.connected) {
    showToast('‚ö†Ô∏è Nicht mit Server verbunden');
    initSocket();
    return;
  }
  
  if (state.inCall) {
    showToast('‚ö†Ô∏è Beende erst den aktuellen Chat');
    return;
  }
  
  // Apply filters
  if (Object.keys(filters).length > 0) {
    state.filters = { ...state.filters, ...filters };
  }
  
  // Update user preferences
  if (state.user) {
    state.user.lookingFor = state.filters.gender;
    state.socket.emit('update-profile', {
      lookingFor: state.filters.gender,
      country: state.filters.country
    });
  }
  
  // Start search
  state.socket.emit('find-match', state.filters);
  
  // Visual feedback
  vibrate([50]);
  showToast('üîç Suche nach Partnern...');
}

function instantConnect() {
  if (!state.socket) {
    showToast('‚ö†Ô∏è Nicht verbunden');
    return;
  }
  
  if (state.user && state.user.gems < 10) {
    showToast('‚ö†Ô∏è Nicht genug Gems f√ºr Instant Connect');
    showPurchaseModal();
    return;
  }
  
  state.socket.emit('instant-connect');
  showToast('‚ö° Instant Connect gestartet...');
}

function filteredSearch(customFilters) {
  const filters = {
    ...state.filters,
    ...customFilters,
    mode: 'filtered'
  };
  
  state.socket.emit('filtered-search', filters);
}

function checkOnlineUsers() {
  // Fetch online users from API
  fetch('/api/users/online')
    .then(res => res.json())
    .then(data => {
      if (data.users && data.users.length > 0) {
        updateOnlineUsersList(data.users);
      }
    })
    .catch(console.error);
}

// ============================================
// WEBRTC ENHANCEMENTS
// ============================================

// Enhanced ICE servers for better connectivity
const ENHANCED_ICE_SERVERS = [
  // Google STUN
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' },
  { urls: 'stun:stun3.l.google.com:19302' },
  { urls: 'stun:stun4.l.google.com:19302' },
  
  // Twilio STUN (free tier)
  { urls: 'stun:global.stun.twilio.com:3478?transport=udp' },
  
  // Public TURN servers
  {
    urls: 'turn:openrelay.metered.ca:80',
    username: 'openrelayproject',
    credential: 'openrelayproject'
  },
  {
    urls: 'turn:openrelay.metered.ca:443',
    username: 'openrelayproject',
    credential: 'openrelayproject'
  },
  {
    urls: 'turn:openrelay.metered.ca:443?transport=tcp',
    username: 'openrelayproject',
    credential: 'openrelayproject'
  },
  {
    urls: 'turn:numb.viagenie.ca',
    credential: 'muazkh',
    username: 'webrtc@live.com'
  }
];

// Create peer connection with better error handling
function createPeerConnection() {
  const pc = new RTCPeerConnection({
    iceServers: ENHANCED_ICE_SERVERS,
    iceCandidatePoolSize: 10,
    bundlePolicy: 'max-bundle',
    rtcpMuxPolicy: 'require'
  });
  
  pc.onicecandidateerror = (error) => {
    console.warn('ICE candidate error:', error);
  };
  
  return pc;
}

// ============================================
// UI ENHANCEMENTS
// ============================================

function showSearchingScreen(data) {
  // Update searching overlay
  const overlay = document.getElementById('searchingOverlay');
  if (overlay) {
    overlay.classList.add('active');
    
    // Show position in queue
    const positionEl = overlay.querySelector('#searchingPosition');
    if (positionEl) {
      positionEl.textContent = `Position in Warteschlange: ${data.position}`;
    }
    
    // Animated dots
    const dots = overlay.querySelector('.searching-dots');
    if (dots) {
      let dotCount = 0;
      setInterval(() => {
        dotCount = (dotCount + 1) % 4;
        dots.textContent = '.'.repeat(dotCount);
      }, 500);
    }
  }
}

function showMatchFound(data) {
  // Show match animation
  const matchOverlay = document.getElementById('matchOverlay');
  if (matchOverlay) {
    const nameEl = matchOverlay.querySelector('#matchName');
    if (nameEl) {
      nameEl.textContent = `${data.partner.country.code} ${data.partner.name}`;
    }
    
    matchOverlay.classList.add('active');
    
    // Hide after 2 seconds
    setTimeout(() => {
      matchOverlay.classList.remove('active');
      showCallInterface();
    }, 2000);
  }
  
  // Update partner info
  updatePartnerInfo(data.partner);
}

function showCallInterface() {
  // Show call controls
  document.getElementById('actionRow').classList.add('active');
  document.getElementById('partnerInfo').classList.add('active');
  
  // Enable chat
  document.getElementById('chatInput').disabled = false;
  document.getElementById('chatSendBtn').disabled = false;
}

function updatePartnerInfo(partner) {
  const elements = {
    name: document.getElementById('partnerName'),
    country: document.getElementById('partnerCountry'),
    avatar: document.getElementById('partnerAvatar'),
    age: document.getElementById('partnerAge'),
    interests: document.getElementById('partnerInterests')
  };
  
  if (elements.name) elements.name.textContent = partner.name;
  if (elements.country) elements.country.textContent = partner.country.name;
  if (elements.avatar) elements.avatar.textContent = partner.country.code;
  
  // Show age if available
  if (elements.age && partner.age) {
    elements.age.textContent = `${partner.age} Jahre`;
    elements.age.style.display = 'block';
  }
  
  // Show interests if available
  if (elements.interests && partner.interests && partner.interests.length > 0) {
    elements.interests.textContent = `Interessen: ${partner.interests.join(', ')}`;
    elements.interests.style.display = 'block';
  }
}

// ============================================
// INITIALIZATION
// ============================================

document.addEventListener('DOMContentLoaded', () => {
  // Check if WebRTC is supported
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('‚ö†Ô∏è Dein Browser unterst√ºtzt keine Video-Chats');
    return;
  }
  
  // Initialize everything
  initSocket();
  setupEventListeners();
  setupCamera();
  
  // Auto-check for online users every 30 seconds
  setInterval(checkOnlineUsers, 30000);
  
  // Show install prompt for PWA
  if ('serviceWorker' in navigator && 'BeforeInstallPromptEvent' in window) {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      showInstallPrompt();
    });
  }
});

function setupEventListeners() {
  // Start buttons
  document.querySelectorAll('.start-search-btn').forEach(btn => {
    btn.addEventListener('click', () => startSearch());
  });
  
  // Instant connect
  const instantBtn = document.getElementById('instantConnectBtn');
  if (instantBtn) {
    instantBtn.addEventListener('click', instantConnect);
  }
  
  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const filter = e.target.dataset.filter;
      const value = e.target.dataset.value;
      
      if (filter && value) {
        startSearch({ [filter]: value });
      }
    });
  });
  
  // Next partner
  const nextBtn = document.getElementById('nextBtn');
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      state.socket.emit('next-partner');
      endCall('Skipped to next');
    });
  }
  
  // End call
  const endBtn = document.getElementById('endBtn');
  if (endBtn) {
    endBtn.addEventListener('click', () => {
      state.socket.emit('end-call');
      endCall('Call ended');
    });
  }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showToast(message, type = 'info') {
  // Create toast element
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'error' ? '#e94560' : type === 'success' ? '#16c79a' : '#1a1a2e'};
    color: white;
    padding: 12px 24px;
    border-radius: 30px;
    z-index: 10000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: slideUp 0.3s ease-out;
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 3 seconds
  setTimeout(() => {
    toast.style.animation = 'slideDown 0.3s ease-out forwards';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

function vibrate(pattern) {
  if (navigator.vibrate) {
    navigator.vibrate(pattern);
  }
}

function endCall(reason) {
  state.inCall = false;
  state.partner = null;
  
  // Hide call interface
  document.getElementById('actionRow').classList.remove('active');
  document.getElementById('partnerInfo').classList.remove('active');
  
  // Clear remote video
  const remoteVideo = document.getElementById('remoteVideo');
  if (remoteVideo) {
    remoteVideo.srcObject = null;
  }
  
  // Show placeholder
  const placeholder = document.getElementById('remotePlaceholder');
  if (placeholder) {
    placeholder.style.display = 'flex';
  }
  
  // Show toast
  showToast(`üìû ${reason}`, 'info');
}
    </script>
</body>
</html>